<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD Simplified DocBook XML V1.1//EN" "http://www.oasis-open.org/docbook/xml/simple/1.1/sdocbook.dtd">
<article id="authentication">
  <title>Authentication</title>
  <para> Our application now has all the features it needs. The only thing missing is some kind of user management.
    Every owner should be able to add and edit his/her pets and add visits, but should not be able to do this with the
    pets of other owners. So we have to know, which owner is currently using the system. We need some kind of
    authentication. </para>
  <para>In this chapter we will add a simple login to our application</para>
  <section>
    <title>Adding authentication data to the database</title>
    <para> First we need to handle some kind of login information. For this we create a database table
        <systemitem>users</systemitem> to store it. This table needs a reference to the corresponding owner or vet.
      Unfortunately we currently have no common table for owners and vets. Owners and vets already have some data in
      common, so it seems naturally to create a common base-table. We name it <systemitem>persons</systemitem> and we
      put the <systemitem>first_name</systemitem> and <systemitem>last_name</systemitem> into it. The
        <systemitem>users</systemitem> table can then reference the table <systemitem>persons</systemitem>. </para>
    <para> Again we change the database schema in the file <filename>initDB.sql</filename> (in
        <filename>src/main/resources/db/hsqldb/</filename>). Change the following lines </para>
    <programlisting>
DROP TABLE vet_specialties IF EXISTS;
DROP TABLE visits IF EXISTS;
DROP TABLE vets IF EXISTS;
DROP TABLE specialties IF EXISTS;
DROP TABLE pets IF EXISTS;
DROP TABLE types IF EXISTS;
DROP TABLE owners IF EXISTS;

CREATE TABLE vets (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 0) NOT NULL PRIMARY KEY,
    first_name VARCHAR(30),
    last_name VARCHAR(30)
);
CREATE INDEX vets_last_name ON vets(last_name);

[...]

CREATE TABLE owners (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 0) NOT NULL PRIMARY KEY,
    first_name VARCHAR(30),
    last_name VARCHAR(30)
    address VARCHAR(255),
    city VARCHAR(80),
    telephone VARCHAR(20)
);
CREATE INDEX owners_last_name ON owners(last_name);
    </programlisting>
    <para> into </para>
    <programlisting>
DROP TABLE vet_specialties IF EXISTS;
DROP TABLE visits IF EXISTS;
DROP TABLE vets IF EXISTS;
DROP TABLE specialties IF EXISTS;
DROP TABLE pets IF EXISTS;
DROP TABLE types IF EXISTS;
DROP TABLE owners IF EXISTS;
DROP TABLE users IF EXISTS;
DROP TABLE persons IF EXISTS;

CREATE TABLE persons(
    id INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 0) NOT NULL PRIMARY KEY,
    first_name VARCHAR(30),
    last_name VARCHAR(30)
);
CREATE INDEX persons_last_name ON persons(last_name);

CREATE TABLE users(
    id INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 0) NOT NULL PRIMARY KEY,
    username VARCHAR(30),
    password VARCHAR(32),
    person_id INTEGER NOT NULL
);
ALTER TABLE users ADD CONSTRAINT fk_users_persons FOREIGN KEY (person_id) REFERENCES persons(id);
CREATE INDEX users_username ON users(username);

CREATE TABLE vets (
    id INTEGER NOT NULL PRIMARY KEY
);
ALTER TABLE vets ADD CONSTRAINT fk_vets_persons FOREIGN KEY (id) REFERENCES persons(id);

[...]

CREATE TABLE owners (
    id INTEGER NOT NULL PRIMARY KEY,
    address VARCHAR(255),
    city VARCHAR(80),
    telephone VARCHAR(20)
);
ALTER TABLE owners ADD CONSTRAINT fk_owners_persons FOREIGN KEY(id) REFERENCES persons(id);
    </programlisting>
    <para> Additionally we have to change the data to insert in the file <filename>populateDB.sql</filename> (in
        <filename>src/main/resources/db/hsqldb/</filename>). First we add the inserts for the table
      <systemitem>persons</systemitem>. </para>
    <programlisting>
INSERT INTO persons VALUES(1,'James','Carter');
INSERT INTO persons VALUES(2,'Helen','Leary');
INSERT INTO persons VALUES(3,'Linda','Douglas');
INSERT INTO persons VALUES(4,'Rafael','Ortega');
INSERT INTO persons VALUES(5,'Henry','Stevens');
INSERT INTO persons VALUES(6,'Sharon','Jenkins');
INSERT INTO persons VALUES(7,'George','Franklin');
INSERT INTO persons VALUES(8,'Betty','Davis');
INSERT INTO persons VALUES(9,'Eduardo','Rodriquez');
INSERT INTO persons VALUES(10,'Harold','Davis');
INSERT INTO persons VALUES(11,'Peter','McTavish');
INSERT INTO persons VALUES(12,'Jean','Coleman');
INSERT INTO persons VALUES(13,'Jeff','Black');
INSERT INTO persons VALUES(14,'Maria','Escobito');
INSERT INTO persons VALUES(15,'David','Schroeder');
INSERT INTO persons VALUES(16,'Carlos','Estaban');
    </programlisting>
    <para> Second we remove the names from the inserts into the table <systemitem>VETS</systemitem>. </para>
    <para> Change </para>
    <programlisting>
INSERT INTO vets VALUES(1,'James','Carter');
INSERT INTO vets VALUES(2,'Helen','Leary');
INSERT INTO vets VALUES(3,'Linda','Douglas');
INSERT INTO vets VALUES(4,'Rafael','Ortega');
INSERT INTO vets VALUES(5,'Henry','Stevens');
INSERT INTO vets VALUES(6,'Sharon','Jenkins');
    </programlisting>
    <para> into </para>
    <programlisting>
INSERT INTO vets VALUES(1);
INSERT INTO vets VALUES(2);
INSERT INTO vets VALUES(3);
INSERT INTO vets VALUES(4);
INSERT INTO vets VALUES(5);
INSERT INTO vets VALUES(6);
    </programlisting>
    <para> Third we remove the names from the inserts into the table <systemitem>OWNERS</systemitem> and fix the
      indices. </para>
    <para> Change </para>
    <programlisting>
INSERT INTO owners VALUES(1,'George','Franklin','110 W. Liberty St.','Madison','6085551023');
INSERT INTO owners VALUES(2,'Betty','Davis','638 Cardinal Ave.','Sun Prairie','6085551749');
INSERT INTO owners VALUES(3,'Eduardo','Rodriquez','2693 Commerce St.','McFarland','6085558763');
INSERT INTO owners VALUES(4,'Harold','Davis','563 Friendly St.','Windsor','6085553198');
INSERT INTO owners VALUES(5,'Peter','McTavish','2387 S. Fair Way','Madison','6085552765');
INSERT INTO owners VALUES(6,'Jean','Coleman','105 N. Lake St.','Monona','6085552654');
INSERT INTO owners VALUES(7,'Jeff','Black','1450 Oak Blvd.','Monona','6085555387');
INSERT INTO owners VALUES(8,'Maria','Escobito','345 Maple St.','Madison','6085557683');
INSERT INTO owners VALUES(9,'David','Schroeder','2749 Blackhawk Trail','Madison','6085559435');
INSERT INTO owners VALUES(10,'Carlos','Estaban','2335 Independence La.','Waunakee','6085555487');
    </programlisting>
    <para> into </para>
    <programlisting>
INSERT INTO owners VALUES(7,'110 W. Liberty St.','Madison','6085551023');
INSERT INTO owners VALUES(8,'638 Cardinal Ave.','Sun Prairie','6085551749');
INSERT INTO owners VALUES(9,'2693 Commerce St.','McFarland','6085558763');
INSERT INTO owners VALUES(10,'563 Friendly St.','Windsor','6085553198');
INSERT INTO owners VALUES(11,'2387 S. Fair Way','Madison','6085552765');
INSERT INTO owners VALUES(12,'105 N. Lake St.','Monona','6085552654');
INSERT INTO owners VALUES(13,'1450 Oak Blvd.','Monona','6085555387');
INSERT INTO owners VALUES(14,'345 Maple St.','Madison','6085557683');
INSERT INTO owners VALUES(15,'2749 Blackhawk Trail','Madison','6085559435');
INSERT INTO owners VALUES(16,'2335 Independence La.','Waunakee','6085555487');
    </programlisting>
    <para> Now we fix the owner-indices of the pets. </para>
    <para> Change </para>
    <programlisting>
INSERT INTO pets VALUES(1,'Leo','2000-09-07',1,1);
INSERT INTO pets VALUES(2,'Basil','2002-08-06',6,2);
INSERT INTO pets VALUES(3,'Rosy','2001-04-17',2,3);
INSERT INTO pets VALUES(4,'Jewel','2000-03-07',2,3);
INSERT INTO pets VALUES(5,'Iggy','2000-11-30',3,4);
INSERT INTO pets VALUES(6,'George','2000-01-20',4,5);
INSERT INTO pets VALUES(7,'Samantha','1995-09-04',1,6);
INSERT INTO pets VALUES(8,'Max','1995-09-04',1,6);
INSERT INTO pets VALUES(9,'Lucky','1999-08-06',5,7);
INSERT INTO pets VALUES(10,'Mulligan','1997-02-24',2,8);
INSERT INTO pets VALUES(11,'Freddy','2000-03-09',5,9);
INSERT INTO pets VALUES(12,'Lucky','2000-06-24',2,10);
INSERT INTO pets VALUES(13,'Sly','2002-06-08',1,10);
    </programlisting>
    <para> into </para>
    <programlisting>
INSERT INTO pets VALUES(1,'Leo','2000-09-07',1,7);
INSERT INTO pets VALUES(2,'Basil','2002-08-06',6,8);
INSERT INTO pets VALUES(3,'Rosy','2001-04-17',2,9);
INSERT INTO pets VALUES(4,'Jewel','2000-03-07',2,9);
INSERT INTO pets VALUES(5,'Iggy','2000-11-30',3,10);
INSERT INTO pets VALUES(6,'George','2000-01-20',4,11);
INSERT INTO pets VALUES(7,'Samantha','1995-09-04',1,12);
INSERT INTO pets VALUES(8,'Max','1995-09-04',1,12);
INSERT INTO pets VALUES(9,'Lucky','1999-08-06',5,13);
INSERT INTO pets VALUES(10,'Mulligan','1997-02-24',2,14);
INSERT INTO pets VALUES(11,'Freddy','2000-03-09',5,15);
INSERT INTO pets VALUES(12,'Lucky','2000-06-24',2,16);
INSERT INTO pets VALUES(13,'Sly','2002-06-08',1,16);
    </programlisting>
    <para> Last we have to insert the credentials to log in the users. </para>
    <para> Add </para>
    <programlisting>
INSERT INTO users VALUES(1,'james','b4cc344d25a2efe540adbf2678e2304c',1);
INSERT INTO users VALUES(2,'helen','7a2eb41a38a8f4e39c1586649da21e5f',2);
INSERT INTO users VALUES(3,'linda','eaf450085c15c3b880c66d0b78f2c041',3);
INSERT INTO users VALUES(4,'rafael','9135d8523ad3da99d8a4eb83afac13d1',4);
INSERT INTO users VALUES(5,'henry','027e4180beedb29744413a7ea6b84a42',5);
INSERT INTO users VALUES(6,'sharon','215a6517848319b70f3f450da480d888',6);
INSERT INTO users VALUES(7,'george','9b306ab04ef5e25f9fb89c998a6aedab',7);
INSERT INTO users VALUES(8,'betty','82b054bd83ffad9b6cf8bdb98ce3cc2f',8);
INSERT INTO users VALUES(9,'rod','52c59993d8e149a1d70b65cb08abf692',9);
INSERT INTO users VALUES(10,'harold','c57f431343f100b441e268cc12babc34',10);
INSERT INTO users VALUES(11,'peter','51dc30ddc473d43a6011e9ebba6ca770',11);
INSERT INTO users VALUES(12,'jean','b71985397688d6f1820685dde534981b',12);
INSERT INTO users VALUES(13,'jeff','166ee015c0e0934a8781e0c86a197c6e',13);
INSERT INTO users VALUES(14,'maria','263bce650e68ab4e23f28263760b9fa5',14);
INSERT INTO users VALUES(15,'david','172522ec1028ab781d9dfd17eaca4427',15);
INSERT INTO users VALUES(16,'carlos','dc599a9972fde3045dab59dbd1ae170b',16);
    </programlisting>
    <para> The encoded passwords are the same as the appropriate user name. They may be changed later. </para>
  </section>
  <section>
    <title>Adding the Authentication Model</title>
    <para> Now we add <filename>Credential.java</filename> in
        <filename>src/main/java/org/springframework/samples/petclinic/model</filename> with the following content. We
      implement the <systemitem>org.springframework.security.userdetails.UserDetails</systemitem> interface as later we
      will use Spring-Security for login. </para>
    <programlisting>
      <![CDATA[
package org.springframework.samples.petclinic.model;


import java.util.Collections;
import java.util.List;

import javax.persistence.CascadeType;
import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.FetchType;
import javax.persistence.JoinColumn;
import javax.persistence.OneToOne;
import javax.persistence.Table;
import javax.persistence.Transient;

import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.GrantedAuthorityImpl;
import org.springframework.security.authentication.encoding.Md5PasswordEncoder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.util.StringUtils;

@Entity
@Table(name = "users")
public class Credential extends BaseEntity implements UserDetails {

    private static final List<GrantedAuthority> USER_AUTHORITIES
        = Collections.<GrantedAuthority>singletonList(new GrantedAuthorityImpl("ROLE_USER"));

    @Column(name = "username")
    private String username;

    @Column(name = "password")
    private String password;

    @OneToOne(cascade = CascadeType.ALL, fetch = FetchType.LAZY)
    @JoinColumn(name = "person_id")
    private Person user;
    
    public String getUsername() {
        return username;
    }
    
    public void setUsername(String username) {
        this.username = username;
    }

    public String getPassword() {
        return password;
    }
    
    public void setPassword(String password) {
        this.password = password;
    }
    
    public String getNewPassword() {
        return "new password";
    }
    
    @Transient
    public void setNewPassword(String password) {
        if (StringUtils.hasText(password)) {
            setPassword(new Md5PasswordEncoder().encodePassword(password, null));
        }
    }
    
    public Person getUser() {
        return user;
    }
    
    public void setUser(Person user) {
        this.user = user;
    }

    @Transient
    public List<GrantedAuthority> getAuthorities() {
        return USER_AUTHORITIES;
    }

    @Transient
    public boolean isEnabled() {
        return true;
    }

    @Transient
    public boolean isAccountNonExpired() {
        return true;
    }

    @Transient
    public boolean isAccountNonLocked() {
        return true;
    }

    @Transient
    public boolean isCredentialsNonExpired() {
        return true;
    }
    
    public boolean equals(Object object) {
        return object instanceof Credential? super.equals(object): false;
    }
}
      ]]>
    </programlisting>
    <para> We change <filename>Person.java</filename> in
        <filename>src/main/java/org/springframework/samples/petclinic/model/</filename> to link to the credentials. </para>
    <para>Change</para>
    <programlisting>
    <![CDATA[     
@MappedSuperclass
public class Person extends BaseEntity
    ]]>
    </programlisting>
    <para>into</para>
    <programlisting>
    <![CDATA[      
@Entity
@Table(name = "persons")
@Inheritance(strategy=InheritanceType.JOINED)
public class Person extends BaseEntity
    ]]>
    </programlisting>
    <para> and add </para>
    <programlisting>
      <![CDATA[      
@OneToOne(cascade = CascadeType.ALL, mappedBy = "user", fetch = FetchType.EAGER)
private Credential credential;

public Credential getCredential() {
    return credential;
}

public void setCredential(Credential credential) {
    this.credential = credential;
}
    ]]>
    </programlisting>
  </section>
  <section>
    <title>Change the password</title>
    <para> Our application is now able to store usernames and passwords, but there is no possibility to input or change
      it. </para>
    <para> We modify the <filename>createOrUpdateOwnerForm.jsp</filename> (in <filename>src/main/webapp/WEB-INF/jsp/owners/</filename>) to
      achive both. We add the fields for username and password between the phone number and the buttons. </para>
    <para> Change </para>
    <programlisting>
      <![CDATA[
<petclinic:inputField label="Telephone" name="telephone"/>

<div class="form-actions">
    <c:choose>
        <c:when test="${owner['new']}">
            <button type="submit">Add Owner</button>
        </c:when>
        <c:otherwise>
            <button type="submit">Update Owner</button>
        </c:otherwise>
    </c:choose>
</div>

[...]

<jsp:include page="../fragments/footer.jsp"/>        
      ]]>
    </programlisting>
    <para> into </para>
    <programlisting>
      <![CDATA[
<petclinic:inputField label="Telephone" name="telephone"/>

<c:choose>
    <c:when test="${owner['new']}">
        <petclinic:inputField label="Username" name="credential.username"/>
    </c:when>
    <c:otherwise>
        Username: ${owner.credential.username}
    </c:otherwise>
</c:choose>

<petclinic:inputField label="Password" name="credential.newPassword"/>


<div class="form-actions">
    <c:choose>
        <c:when test="${owner['new']}">
            <button type="submit">Register Owner</button>
        </c:when>
        <c:otherwise>
            <button type="submit">Update Owner</button>
        </c:otherwise>
    </c:choose>
</div>

[...]

<c:choose>
    <c:when test="${owner['new']}">
        <jsp:include page="../fragments/footer.jsp"/>
    </c:when>
</c:choose>
      ]]>
    </programlisting>
    <para> Now we modify <filename>OwnerController.java</filename> (in
        <filename>src/main/java/org/springframework/samples/petclinic/web/</filename>) to actually store username and
      password. Change </para>
    <programlisting>
      <![CDATA[
@RequestMapping(value = "/owners/new", method = RequestMethod.GET)
public String initCreationForm(Model model) {
    Owner owner = new Owner();
    model.addAttribute(owner);
    return "owners/createOrUpdateOwnerForm";
}
      ]]>
    </programlisting>
    <para> into </para>
    <programlisting>
      <![CDATA[
@RequestMapping(value = "/owners/new", method = RequestMethod.GET)
public String initCreationForm(Model model) {
    Owner owner = new Owner();
    Credential credential = new Credential();
    owner.setCredential(credential);
    credential.setUser(owner);
    model.addAttribute(owner);
    model.addAttribute(credential); //This is for the pre-authentication filter later
    return "owners/createOrUpdateOwnerForm";
}
      ]]>
    </programlisting>
    <para> and </para>
    <programlisting>
      <![CDATA[
@Controller
@SessionAttributes(types = Owner.class)
public class OwnerController {
    ...
}
      ]]>
    </programlisting>
    <para> into </para>
    <programlisting>
      <![CDATA[
@Controller
@SessionAttributes("owner")
public class OwnerController {
    ...
}
      ]]>
    </programlisting>
    <para> and </para>
    <programlisting>
      <![CDATA[
@InitBinder
public void setAllowedFields(WebDataBinder dataBinder) {
    dataBinder.setDisallowedFields("id");
}
      ]]>
    </programlisting>
    <para> into </para>
    <programlisting>
      <![CDATA[
@InitBinder
public void setAllowedFields(WebDataBinder dataBinder) {
    dataBinder.setDisallowedFields("id","username");
}
      ]]>
    </programlisting>
    <para> Additionally we want to check that the user did not input an empty password (especially when the user is
      created, otherwise the current password can be taken), so we have to create the
        <filename>OwnerValidator.java</filename> (in
        <filename>src/main/java/org/springframework/samples/petclinic/web/</filename>). </para>
    <para> Add the following code. </para>
    <programlisting>
      <![CDATA[
package org.springframework.samples.petclinic.web;

import org.springframework.samples.petclinic.model.Owner;
import org.springframework.util.StringUtils;
import org.springframework.validation.Errors;

/**
 * <code>Validator</code> for <code>Owner</code> forms.
 *
 */
public class OwnerValidator {

    public void validate(Owner owner, Errors errors) {
        if (!StringUtils.hasLength(owner.getCredential().getUsername())) {
            errors.rejectValue("credential.username", "required", "required");
        }
        if (owner.getCredential().isNew() && !StringUtils.hasLength(owner.getCredential().getPassword())) {
            errors.rejectValue("credential.newPassword", "required", "required");
        }
    }
}
      ]]>
    </programlisting>
  </section>
  <section>
      <title>Change save-method</title>
      <para>
      We have to change the <systemitem>save</systemitem>-method for owners because after registrating a new owner this owner should be login immediately. Therefore we need the new ids
      of this owner and of the belonging credential. So we have to change some code. In <filename>ClinicService.java</filename> (in 
      <filename>src/main/java/org/springframework/samples/petclinic/service/</filename>) change
      </para>
      <programlisting>
      <![CDATA[
public void saveOwner(Owner owner) throws DataAccessException;
      ]]>          
      </programlisting>
      <para>into</para>
      <programlisting>
      <![CDATA[
public Owner saveOwner(Owner owner) throws DataAccessException;
      ]]>          
      </programlisting>
      <para>So we have to change also the implementation of <filename>ClinicService</filename>. Change the following code in <filename>ClinicServiceImpl.java</filename>
          (in <filename>src/main/java/org/springframework/samples/petclinic/service/</filename>)
      </para>
      <programlisting>
      <![CDATA[
@Override
@Transactional
public void saveOwner(Owner owner) throws DataAccessException {
    return ownerRepository.save(owner);
}
      ]]>          
      </programlisting>
      <para>into</para>
      <programlisting>
      <![CDATA[
@Override
@Transactional
public Owner saveOwner(Owner owner) throws DataAccessException {
    return ownerRepository.save(owner);
}
      ]]>          
      </programlisting>
      <para>Now the repository of owners has to return a owner, when calling the <systemitem>save</systemitem>-method. Hence we change in <filename>OwnerRepository.java</filename> (in 
      <filename>src/main/java/org/springframework/samples/petclinic/repository/</filename>)
      </para>
      <programlisting>
      <![CDATA[
/**
 * Save an <code>Owner</code> to the data store, either inserting or updating it.
 *
 * @param owner the <code>Owner</code> to save
 * @see BaseEntity#isNew
 */
void save(Owner owner) throws DataAccessException;
      ]]>          
      </programlisting>
      <para>into</para>
      <programlisting>
      <![CDATA[
/**
 * Save an <code>Owner</code> to the data store, either inserting or updating it.
 *
 * @param owner the <code>Owner</code> to save
 * @return the <code>Owner</code> which was saved
 * @see BaseEntity#isNew
 */
Owner save(Owner owner) throws DataAccessException;
      ]]>          
      </programlisting>
      <para>The last thing we do is to change the implementation of the repository for owners. Change the following code in <filename>JpaOwnerRepositoryImpl.java</filename> ( in
          <filename>src/main/java/org/springframework/samples/petclinic/repository/jpa/</filename>)</para>
      <programlisting>
      <![CDATA[
@Override
public void save(Owner owner) {
    if (owner.getId() == null) {
        this.em.persist(owner);
    } else {
        this.em.merge(owner);
    }
}
      ]]>          
      </programlisting>
      <para>into</para>
      <programlisting>
      <![CDATA[
@Override
public Owner save(Owner owner) {
    Owner merged = null;
    if(owner.getId() != null) {
    	Owner o = findById(owner.getId());
    	o.setFirstName(owner.getFirstName());
    	o.setLastName(owner.getLastName());
    	o.setAddress(owner.getAddress());
    	o.setCity(owner.getCity());
    	o.setTelephone(owner.getTelephone());
    	o.getCredential().setPassword(owner.getCredential().getNewPassword());
        merged = this.em.merge(o);
    } else {
    	merged = this.em.merge(owner);
    }
    this.em.flush();
    return merged;
}
      ]]>
      </programlisting>
  </section>
  <section>
    <title>Integrating Spring Security</title>
    <para> We now need a simple login mechanism. Since we want to use Spring-Security, we create a credential-service
      that implements the <systemitem>org.springframework.security.userdetails.UserDetailsService</systemitem>
      interface. Before we add the credential-service, we first have to add a new repository for the credential. Therefore add the interface
      <filename>CredentialRepository.java</filename> in <filename>src/main/java/org/springframework/samples/petclinic/repository</filename>
      with the following content:</para>
      <programlisting>
      <![CDATA[
package org.springframework.samples.petclinic.repository;

import org.jpasecurity.AccessType;

import org.springframework.dao.DataAccessException;
import org.springframework.samples.petclinic.model.Credential;

public interface CredentialRepository {

    Credential findById(int id) throws DataAccessException;

    Credential findByUsername(String username) throws DataAccessException; 

    boolean isAccessible(AccessType accessType, String entityName,Object... constructorArgs);
	
    boolean isAccessible(AccessType accessType, Object entity);
}
      ]]>
      </programlisting>
      <para>The implementation of this interface, <filename>JpaCredentialRepositoryImpl.java</filename>, has to be added in 
          <filename>src/main/java/org/springframework/samples/petclinic/repository/jpa</filename> with the following content:</para>
      <programlisting>
      <![CDATA[
package org.springframework.samples.petclinic.repository.jpa;

import javax.persistence.NoResultException;
import javax.persistence.PersistenceContext;
import javax.persistence.TypedQuery;

import org.jpasecurity.AccessType;
import org.jpasecurity.persistence.SecureEntityManager;

import org.springframework.dao.DataAccessException;
import org.springframework.samples.petclinic.model.Credential;
import org.springframework.samples.petclinic.repository.CredentialRepository;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Repository;

@Repository
public class JpaCredentialRepositoryImpl implements CredentialRepository{

    @PersistenceContext
    private SecureEntityManager em;

    @Override
    public Credential findById(int id) throws DataAccessException {
        TypedQuery<Credential> query = this.em.createQuery("SELECT credential FROM Credential credential "
            + " INNER JOIN FETCH credential.user"
            + " WHERE credential.id = :id", Credential.class);
        query.setParameter("id", id);
        return query.getSingleResult();
    }

    @Override
    public Credential findByUsername(String username) {
        try {
            TypedQuery<Credential> query = this.em.createQuery("SELECT credential FROM Credential credential "
                + "WHERE credential.username = :username", Credential.class);
            query.setParameter("username", username);
            return query.getSingleResult();
        } catch (NoResultException e) {
            throw new UsernameNotFoundException(username, e);
        }
    }

    @Override
    public boolean isAccessible(AccessType accessType, String entityName,
            Object... constructorArgs) {
        return this.em.isAccessible(accessType, entityName, constructorArgs);
    }

    @Override
    public boolean isAccessible(AccessType accessType, Object entity) {
        return this.em.isAccessible(accessType, entity);
    }
}
      ]]>
      </programlisting>
    <para> We create now a package <systemitem>security</systemitem> (by creating the folder
        <filename>src/main/java/org/springframework/samples/petclinic/security/</filename>) and put the interface
        <filename>CredentialService.java</filename> into it. It extends <filename>UserDetailsService</filename>, so that
        the implementation of the interface has to implement it too.</para>
    <para> The content of <filename>CredentialService.java</filename> follows: </para>
    <programlisting>
      <![CDATA[
package org.springframework.samples.petclinic.security;

import org.jpasecurity.AccessManager;
import org.jpasecurity.AccessType;

import org.springframework.dao.DataAccessException;
import org.springframework.samples.petclinic.model.Credential;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;

public interface CredentialService extends UserDetailsService, AccessManager {

    public Credential loadUserByUsername(String username) throws UsernameNotFoundException, DataAccessException;

    public Credential findCredentialById(int id) throws DataAccessException;
	
    public boolean isAccessible(AccessType accessType, String entityName, Object... constructorArgs);

    public boolean isAccessible(AccessType accessType, Object entity);
}
      ]]>
    </programlisting>
    <para>In the same package we create the implementation of <filename>CredentialService.java</filename>. Add <filename>CredentialServiceImpl.java</filename>
        in <filename>src/main/java/org/springframework/samples/petclinic/security/</filename>:</para>
      <programlisting>
      <![CDATA[
package org.springframework.samples.petclinic.security;

import org.jpasecurity.AccessType;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.dao.DataAccessException;
import org.springframework.samples.petclinic.model.Credential;
import org.springframework.samples.petclinic.repository.CredentialRepository;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
public class CredentialServiceImpl implements CredentialService{

    private CredentialRepository credentialRepository;

    @Autowired
    public CredentialServiceImpl(CredentialRepository credentialRepository) {
        this.credentialRepository = credentialRepository;
    }

    @Transactional(readOnly = true)
    public Credential loadUserByUsername(String username) throws UsernameNotFoundException, DataAccessException{
        return credentialRepository.findByUsername(username);
    }

    @Transactional(readOnly = true)
    public Credential findCredentialById(int id) throws DataAccessException {
        return credentialRepository.findById(id);
    }

    @Transactional
    public boolean isAccessible(AccessType accessType, String entityName,
            Object... constructorArgs) {
        return credentialRepository.isAccessible(accessType, entityName, constructorArgs);
    }

    @Transactional
    public boolean isAccessible(AccessType accessType, Object entity) {
        return credentialRepository.isAccessible(accessType, entity);
    }
}
      ]]>
    </programlisting>     
    <para> We add the security configuration to the Spring business configuration
        (<filename>src/main/resources/spring/business-config.xml</filename>). </para>
    <para> First change </para>
    <programlisting>
      <![CDATA[
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:p="http://www.springframework.org/schema/p" xmlns:context="http://www.springframework.org/schema/context"
    xmlns:tx="http://www.springframework.org/schema/tx" xmlns:jpa="http://www.springframework.org/schema/data/jpa"
    xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/data/jpa http://www.springframework.org/schema/data/jpa/spring-jpa.xsd
        http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd
        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd">
      ]]>
    </programlisting>
    <para> into </para>
    <programlisting>
      <![CDATA[
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:p="http://www.springframework.org/schema/p" xmlns:context="http://www.springframework.org/schema/context"
    xmlns:tx="http://www.springframework.org/schema/tx" xmlns:jpa="http://www.springframework.org/schema/data/jpa"
    xmlns:sec="http://www.springframework.org/schema/security"
    xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/data/jpa http://www.springframework.org/schema/data/jpa/spring-jpa.xsd
        http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd
        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
        http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-3.1.xsd">
      ]]>
    </programlisting>
    <para> Now change the following configuration of the <filename>business-config.xml</filename>. Change</para>
    <programlisting>
        <![CDATA[
<beans profile="default">
    [...]
    <bean class="org.springframework.dao.annotation.PersistenceExceptionTranslationPostProcessor"/>
</beans>
    ]]>
    </programlisting>
     <para>into</para>
    <programlisting>
      <![CDATA[
<beans profile="default">
    [...]
    <bean class="org.springframework.dao.annotation.PersistenceExceptionTranslationPostProcessor"/>

    <sec:http pattern="/login" security="none"/>
    <sec:http auto-config="true">
        <sec:intercept-url pattern="/static/*" access="IS_AUTHENTICATED_ANONYMOUSLY" />
        <sec:intercept-url pattern="/owners/new" access="IS_AUTHENTICATED_ANONYMOUSLY" />
        <sec:intercept-url pattern="/**" access="ROLE_USER" />
        <sec:form-login login-page="/login" default-target-url="/"/>
        <sec:logout />
    </sec:http>

    <sec:authentication-manager>
        <sec:authentication-provider user-service-ref="userService">
          <sec:password-encoder hash="md5"/>
        </sec:authentication-provider>
    </sec:authentication-manager>

    
    <bean id="userService" class="org.springframework.samples.petclinic.security.CredentialServiceImpl" />
</beans>
      ]]>
    </programlisting>
    <para> With this configuration access to our pages is allowed only for users with the role
        <systemitem>ROLE_USER</systemitem> (which are all owners and vets). Only access to our login page and to our
      page to add owners is allowed for everyone. The latter is needed to enable new users to register. </para>
    <para> Now we need a login page. We create the file <filename>login.jsp</filename> in
        <filename>src/main/webapp/WEB-INF/jsp/</filename> with the following content. </para>
    <programlisting>
      <![CDATA[
<!DOCTYPE html> 
<%@ page import="org.springframework.security.web.authentication.AbstractAuthenticationProcessingFilter" %>
<%@ page import="org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter" %>
<%@ page import="org.springframework.security.core.AuthenticationException" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>

<html lang="en">


<jsp:include page="fragments/headTag.jsp"/>
<jsp:include page="fragments/bodyHeader.jsp"/>
<body>
    <div id="main">
        <form name="f" action="<c:url value='j_spring_security_check'/>" method="POST">
            <table>
                <tr><td>User:</td><td><input type='text' name='j_username' value='<c:if test="${not empty param.login_error}"><c:out value="${SPRING_SECURITY_LAST_USERNAME}"/></c:if>'/></td></tr>
                <tr><td>Password:</td><td><input type='password' name='j_password'></td></tr>
                <tr><td><input type="checkbox" name="_spring_security_remember_me"></td><td>Don't ask for my password for two weeks</td></tr>
          
                <tr><td colspan='2'><p class="submit"><input name="submit" type="submit"></p></td></tr>
                <tr><td colspan='2'><p class="submit"><input name="reset" type="reset"></p></td></tr>
            </table>
      
        </form>
    
        <table class="footer">
            <tr>
                <td><a href="<c:url value="/owners/new"/>">Register</a></td>  
            </tr>
        </table>
    
    </div>
</body>
</html>
      ]]>
    </programlisting>
    <para> With this changes we now are able to log in any user. We now also can improve the creation of users: We are
      now able to check whether a username does already exist and we can automatically log in a newly created user. We
      have to inject the <systemitem>UserDetailsService</systemitem> we just created into the
      <systemitem>OwnerController</systemitem> (in
      <filename>src/main/java/org/springframework/samples/petclinic/web/OwnerController.java</filename>) </para>
    <para> First we add an attribute <systemitem>UserDetailsService</systemitem> and inject it via the constructor.
      Change </para>
    <programlisting>
      <![CDATA[
import java.util.Collection;

import javax.validation.Valid;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.samples.petclinic.model.Owner;
import org.springframework.samples.petclinic.model.Credential;
import org.springframework.samples.petclinic.service.ClinicService;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.WebDataBinder;
import org.springframework.web.bind.annotation.InitBinder;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.SessionAttributes;
import org.springframework.web.bind.support.SessionStatus;
import org.springframework.web.servlet.ModelAndView;

[...]

@Autowired
public OwnerController(ClinicService clinicService) {
    this.clinicService = clinicService;
}
      ]]>
    </programlisting>
    <para> into </para>
    <programlisting>
      <![CDATA[
import java.util.Collection;

import javax.validation.Valid;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.samples.petclinic.model.Owner;
import org.springframework.samples.petclinic.model.Credential;
import org.springframework.samples.petclinic.service.ClinicService;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.validation.BindingResult;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.web.bind.WebDataBinder;
import org.springframework.web.bind.annotation.InitBinder;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.SessionAttributes;
import org.springframework.web.bind.support.SessionStatus;
import org.springframework.web.servlet.ModelAndView;

[...]

private final UserDetailsService userDetailsService;

@Autowired
public OwnerController(ClinicService clinicService, UserDetailsService userDetailsService) {
    this.clinicService = clinicService;
    this.userDetailsService = userDetailsService;
}
      ]]>
    </programlisting>
    <para> Now we can check, whether the username does already exist. In <systemitem>processCreationForm</systemitem> change </para>
    <programlisting>
      <![CDATA[
@RequestMapping(value = "/owners/new", method = RequestMethod.POST)
public String processCreationForm(@Valid Owner owner, BindingResult result, SessionStatus status) {
    if (result.hasErrors()) {
        return "owners/createOrUpdateOwnerForm";
    } 
    ...
}
      ]]>
    </programlisting>
    <para> into </para>
    <programlisting>
      <![CDATA[
@RequestMapping(value = "/owners/new", method = RequestMethod.POST)
public String processCreationForm(@Valid Owner owner, BindingResult result, SessionStatus status) {
    new OwnerValidator().validate(owner, result);
    try {
        userDetailsService.loadUserByUsername(owner.getCredential().getUsername());
        result.rejectValue("credential.username", "alreadyExists", "already exists");
    } catch (UsernameNotFoundException e) {
        //all right, the user does not already exist
    }
    if (result.hasErrors()) {
        return "owners/createOrUpdateOwnerForm";
    } 
    ...
}
      ]]>
    </programlisting>
    <para> To automatically log in the new user, modify the <systemitem>else</systemitem> block in
      <systemitem>processCreationForm</systemitem>. </para>
    <para> Change </para>
    <programlisting>
      <![CDATA[
else {
    this.clinicService.saveOwner(owner);
    status.setComplete();
    return "redirect:/owners/"+ owner.getId();
}
      ]]>
    </programlisting>
    <para> into </para>
    <programlisting>
      <![CDATA[
else {
    owner = this.clinicService.saveOwner(owner);
    Credential credential = owner.getCredential();
    Authentication authentication
      = new UsernamePasswordAuthenticationToken(credential, credential, credential.getAuthorities());
    SecurityContextHolder.getContext().setAuthentication(authentication);
    status.setComplete();
    return "redirect:/";
}
      ]]>
    </programlisting>
    <para> When we are logged in we would expect a personal greeting and a direct link to our pets. </para>
    <para> For this we create the file <filename>ClinicController.java</filename> in
        (<filename>src/main/java/org/springframework/samples/petclinic/web/</filename>). </para>
    <programlisting>
      <![CDATA[
package org.springframework.samples.petclinic.web;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.samples.petclinic.model.Credential;
import org.springframework.samples.petclinic.model.Owner;
import org.springframework.samples.petclinic.model.Person;
import org.springframework.samples.petclinic.model.Vet;
import org.springframework.samples.petclinic.security.CredentialService;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.servlet.ModelAndView;

@Controller
public class ClinicController {

    private final CredentialService credentialService;

    @Autowired
    public ClinicController(CredentialService credentialService) {
        this.credentialService = credentialService;
    }

    /**
     * Custom handler for the welcome view.
     * <p>
     * Note that this handler relies on the RequestToViewNameTranslator to
     * determine the logical view name based on the request URL: "/welcome.do"
     * -&gt; "welcome".
     */
    @RequestMapping("/login")
    public String loginHandler() {
        return "login";
    }
    
    /**
     * Custom handler for the welcome view.
     * <p>
     * Note that this handler relies on the RequestToViewNameTranslator to
     * determine the logical view name based on the request URL: "/welcome.do"
     * -&gt; "welcome".
     */
    @RequestMapping("/")
    public ModelAndView welcomeHandler() {
        Credential credential = (Credential)SecurityContextHolder.getContext().getAuthentication().getPrincipal();
        ModelAndView mav = new ModelAndView("welcome");
        Person user = credentialService.findCredentialById(credential.getId()).getUser();
        mav.addObject("person", user);
        mav.addObject("vet", user instanceof Vet);
        mav.addObject("owner", user instanceof Owner);
        return mav;
    }
}
      ]]>
    </programlisting>
    <para> Now we delete the following data from <filename>bodyHeader.jsp</filename> (from
      <filename>src/main/webapp/WEB-INF/jsp/fragments/</filename>). </para>
    <programlisting>
      <![CDATA[
<div class="navbar" style="width: 601px;">
    <div class="navbar-inner">
        <ul class="nav">
            <li style="width: 100px;"><a href="<spring:url value="/" htmlEscape="true" />"><i class="icon-home"></i>
                Home</a></li>
            <li style="width: 130px;"><a href="<spring:url value="/owners/find.html" htmlEscape="true" />"><i
                    class="icon-search"></i> Find owners</a></li>
            <li style="width: 140px;"><a href="<spring:url value="/vets.html" htmlEscape="true" />"><i
                    class="icon-th-list"></i> Veterinarians</a></li>
            <li style="width: 90px;"><a href="<spring:url value="/oups.html" htmlEscape="true" />"
                                        title="trigger a RuntimeException to see how it is handled"><i
                    class="icon-warning-sign"></i> Error</a></li>
            <li style="width: 80px;"><a href="#" title="not available yet. Work in progress!!"><i
                    class=" icon-question-sign"></i> Help</a></li>
        </ul>
    </div>
</div>
      ]]>
    </programlisting>
    <para> Now we can change <filename>welcome.jsp</filename> (from
        <filename>src/main/webapp/WEB-INF/jsp/</filename>). </para>
    <para> Change </para>
    <programlisting>
      <![CDATA[
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>

[...]

    <h2><fmt:message key="welcome"/></h2>
    <spring:url value="/resources/images/pets.png" htmlEscape="true" var="petsImage"/>
    <img src="${petsImage}"/>
      ]]>
    </programlisting>
    <para> into </para>
    <programlisting>
      <![CDATA[
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
[...]
<ul class="nav">
    <c:choose>
        <c:when test="${vet}">
            <li>
                <spring:url value="/vets/{vetId}" var="vetsUrl">
                    <spring:param name="vetId" value="${person.id}"/>
                </spring:url>
                <a href="${fn:escapeXml(vetsUrl)}">Personal information</a>
            </li>
            <li style="width: 130px;"><a href="<spring:url value="/owners/find.html" htmlEscape="true" />"><i
                    class="icon-search"></i> Find owners</a></li>
        </c:when>
        <c:when test="${owner}">
            <p>&nbsp;</p>
            <li>          
                <spring:url value="/owners/{ownerId}" var="ownerUrl">
                    <spring:param name="ownerId" value="${person.id}"/>
                </spring:url>
                <a href="${fn:escapeXml(ownerUrl)}">Personal information </a>
            </li>
        </c:when>
     </c:choose>
     <li style="width: 140px;"><a href="<spring:url value="/vets.html" htmlEscape="true" />">
        <i class="icon-th-list"></i> Veterinarians</a></li>
     <li style="width: 90px;"><a href="<spring:url value="/oups.html" htmlEscape="true" />"
                                    title="trigger a RuntimeException to see how it is handled">
        <i class="icon-warning-sign"></i> Error</a></li>
     <li style="width: 80px;"><a href="#" title="not available yet. Work in progress!!">
        <i class=" icon-question-sign"></i> Help</a></li>
  </ul>
<h2><fmt:message key="welcome"/> ${person.firstName} ${person.lastName}</h2>
      ]]>
    </programlisting>
    <para> You also may add a logout-link to every page by modifying <filename>footer.jsp</filename> (from
        <filename>src/main/webapp/WEB-INF/jsp/fragments/</filename>). </para>
    <para> Change </para>
    <programlisting>
      <![CDATA[
<td align="right"><img src="<spring:url value="/resources/images/springsource-logo.png" htmlEscape="true" />"
                         alt="Sponsored by SpringSource"/></td>
      ]]>
    </programlisting>
    <para> into </para>
    <programlisting>
      <![CDATA[
<td align="right"><a href='<spring:url value="/j_spring_security_logout"/>'>Logout</a></td>
      ]]>
    </programlisting>
    <para> The last thing we have to do is to add the Spring-Security filter to our <filename>web.xml</filename> (in
        <filename>src/main/webapp/WEB-INF/</filename>). </para>
    <para> Add </para>
    <programlisting>
      <![CDATA[
<filter>
    <filter-name>springSecurityFilterChain</filter-name>
    <filter-class>org.springframework.web.filter.DelegatingFilterProxy</filter-class>
</filter>

<filter-mapping>
    <filter-name>springSecurityFilterChain</filter-name>
    <url-pattern>/*</url-pattern>
</filter-mapping>
      ]]>
    </programlisting>
    <para> When you now start the application you have to login to access the pages. Remember the login data we have put
      into the database (the password was the same as the username) or use the <ulink
        url="http://localhost:9966/petclinic/owners/new">Register</ulink> link from the
      login-page to register a new owner. </para>
  </section>
</article>
