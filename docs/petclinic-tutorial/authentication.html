<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia Site Renderer 1.4 at 2019-07-31 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>JPA Security - 
  Authentication</title>
    <style type="text/css" media="all">
      @import url("../css/maven-base.css");
      @import url("../css/maven-theme.css");
      @import url("../css/site.css");
    </style>
    <link rel="stylesheet" href="../css/print.css" type="text/css" media="print" />
    <meta name="Date-Revision-yyyymmdd" content="20190731" />
    <meta http-equiv="Content-Language" content="en" />
        
        </head>
  <body class="composite">
    <div id="banner">
                    <div id="bannerLeft">
                
                </div>
                          <div id="bannerRight">
                                                <img src="../images/logo.png" alt="$alt" />
                </div>
            <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
                    
                <div class="xleft">
        <span id="publishDate">Last Published: 2019-07-31</span>
                      </div>
            <div class="xright">        
                    
                 <span id="projectVersion">Version: 1.0.0-SNAPSHOT</span>
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
                    
                                <h5>JPA Security</h5>
                  <ul>
                  <li class="none">
                          <a href="../index.html" title="Introduction">Introduction</a>
            </li>
                  <li class="none">
                          <a href="https://sourceforge.net/project/showfiles.php?group_id=219346" class="externalLink" title="Download">Download</a>
            </li>
                                                                                                                    <li class="expanded">
                          <a href="../project-doc.html" title="Documentation">Documentation</a>
                    <ul>
                      <li class="none">
                          <a href="../reference/preface.html" title="Reference Manual">Reference Manual</a>
            </li>
                      <li class="none">
                          <a href="../simple-tutorial/introduction.html" title="Simple Tutorial">Simple Tutorial</a>
            </li>
                      <li class="none">
                          <a href="../petclinic-tutorial/introduction.html" title="Petclinic Tutorial">Petclinic Tutorial</a>
            </li>
                      <li class="none">
                          <a href="../elearning-sample/introduction.html" title="E-Learning Sample">E-Learning Sample</a>
            </li>
              </ul>
        </li>
          </ul>
                       <h5>Project Documentation</h5>
                  <ul>
                                                                                                                                                                                                                                      <li class="collapsed">
                          <a href="../project-info.html" title="Project Information">Project Information</a>
                  </li>
                                                                                                        <li class="collapsed">
                          <a href="../project-reports.html" title="Project Reports">Project Reports</a>
                  </li>
          </ul>
                                                                                                                                     <a href="http://maven.apache.org/" title="Build with Maven 2" class="poweredBy">
        <img class="poweredBy"  alt="Build with Maven 2" src="../images/logos/maven-feather.png"     />
      </a>
                                                                                                                <a href="http://sourceforge.net/donate/index.php?group_id=219346" title="Donate" class="poweredBy">
        <img class="poweredBy"  alt="Donate" src="http://images.sourceforge.net/images/project-support.jpg"     />
      </a>
                                                                                                                <a href="http://sourceforge.net" title="Hosted on SourceForge.net" class="poweredBy">
        <img class="poweredBy"  alt="Hosted on SourceForge.net" src="http://sflogo.sourceforge.net/sflogo.php?group_id=219346&type=9"     />
      </a>
                       
                    
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <div class="section">
<h2></h2><!-- Navigation Panel -->
<table class="bodyTable" width="100%" align="center" border="0">
<tr class="a">
<td align="left">Previous: <a href="model.html">Domain Model</a></td>
<td align="center">Up: <a href="tutorial.html">Tutorial</a></td>
<td align="right">Next: <a href="authorization.html">Authorization</a></td></tr></table><!-- End of Navigation Panel --><hr /></div>
<p> Our application now has all the features it needs. The only thing missing is some kind of user management.
    Every owner should be able to add and edit his/her pets and add visits, but should not be able to do this with the
    pets of other owners. So we have to know, which owner is currently using the system. We need some kind of
    authentication. </p>
  
<p>In this chapter we will add a simple login to our application</p>
  
<div class="section">
<h2>     Adding authentication data to the database<a name="Adding_authentication_data_to_the_database"></a></h2>
    
<p> First we need to handle some kind of login information. For this we create a database table
        <i><tt>users</tt></i> to store it. This table needs a reference to the corresponding owner or vet.
      Unfortunately we currently have no common table for owners and vets. Owners and vets already have some data in
      common, so it seems naturally to create a common base-table. We name it <i><tt>persons</tt></i> and we
      put the <i><tt>first_name</tt></i> and <i><tt>last_name</tt></i> into it. The
        <i><tt>users</tt></i> table can then reference the table <i><tt>persons</tt></i>. </p>
    
<p> Again we change the database schema in the file <tt>initDB.sql</tt> (in
        <tt>src/main/resources/db/hsqldb/</tt>). Change the following lines </p>
    
<div class="source">
<pre>
DROP TABLE vet_specialties IF EXISTS;
DROP TABLE visits IF EXISTS;
DROP TABLE vets IF EXISTS;
DROP TABLE specialties IF EXISTS;
DROP TABLE pets IF EXISTS;
DROP TABLE types IF EXISTS;
DROP TABLE owners IF EXISTS;

CREATE TABLE vets (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 0) NOT NULL PRIMARY KEY,
    first_name VARCHAR(30),
    last_name VARCHAR(30)
);
CREATE INDEX vets_last_name ON vets(last_name);

[...]

CREATE TABLE owners (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 0) NOT NULL PRIMARY KEY,
    first_name VARCHAR(30),
    last_name VARCHAR(30)
    address VARCHAR(255),
    city VARCHAR(80),
    telephone VARCHAR(20)
);
CREATE INDEX owners_last_name ON owners(last_name);
    </pre></div>
    
<p> into </p>
    
<div class="source">
<pre>
DROP TABLE vet_specialties IF EXISTS;
DROP TABLE visits IF EXISTS;
DROP TABLE vets IF EXISTS;
DROP TABLE specialties IF EXISTS;
DROP TABLE pets IF EXISTS;
DROP TABLE types IF EXISTS;
DROP TABLE owners IF EXISTS;
DROP TABLE users IF EXISTS;
DROP TABLE persons IF EXISTS;

CREATE TABLE persons(
    id INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 0) NOT NULL PRIMARY KEY,
    first_name VARCHAR(30),
    last_name VARCHAR(30)
);
CREATE INDEX persons_last_name ON persons(last_name);

CREATE TABLE users(
    id INTEGER GENERATED BY DEFAULT AS IDENTITY(START WITH 0) NOT NULL PRIMARY KEY,
    username VARCHAR(30),
    password VARCHAR(32),
    person_id INTEGER NOT NULL
);
ALTER TABLE users ADD CONSTRAINT fk_users_persons FOREIGN KEY (person_id) REFERENCES persons(id);
CREATE INDEX users_username ON users(username);

CREATE TABLE vets (
    id INTEGER NOT NULL PRIMARY KEY
);
ALTER TABLE vets ADD CONSTRAINT fk_vets_persons FOREIGN KEY (id) REFERENCES persons(id);

[...]

CREATE TABLE owners (
    id INTEGER NOT NULL PRIMARY KEY,
    address VARCHAR(255),
    city VARCHAR(80),
    telephone VARCHAR(20)
);
ALTER TABLE owners ADD CONSTRAINT fk_owners_persons FOREIGN KEY(id) REFERENCES persons(id);
    </pre></div>
    
<p> Additionally we have to change the data to insert in the file <tt>populateDB.sql</tt> (in
        <tt>src/main/resources/db/hsqldb/</tt>). First we add the inserts for the table
      <i><tt>persons</tt></i>. </p>
    
<div class="source">
<pre>
INSERT INTO persons VALUES(1,'James','Carter');
INSERT INTO persons VALUES(2,'Helen','Leary');
INSERT INTO persons VALUES(3,'Linda','Douglas');
INSERT INTO persons VALUES(4,'Rafael','Ortega');
INSERT INTO persons VALUES(5,'Henry','Stevens');
INSERT INTO persons VALUES(6,'Sharon','Jenkins');
INSERT INTO persons VALUES(7,'George','Franklin');
INSERT INTO persons VALUES(8,'Betty','Davis');
INSERT INTO persons VALUES(9,'Eduardo','Rodriquez');
INSERT INTO persons VALUES(10,'Harold','Davis');
INSERT INTO persons VALUES(11,'Peter','McTavish');
INSERT INTO persons VALUES(12,'Jean','Coleman');
INSERT INTO persons VALUES(13,'Jeff','Black');
INSERT INTO persons VALUES(14,'Maria','Escobito');
INSERT INTO persons VALUES(15,'David','Schroeder');
INSERT INTO persons VALUES(16,'Carlos','Estaban');
    </pre></div>
    
<p> Second we remove the names from the inserts into the table <i><tt>VETS</tt></i>. </p>
    
<p> Change </p>
    
<div class="source">
<pre>
INSERT INTO vets VALUES(1,'James','Carter');
INSERT INTO vets VALUES(2,'Helen','Leary');
INSERT INTO vets VALUES(3,'Linda','Douglas');
INSERT INTO vets VALUES(4,'Rafael','Ortega');
INSERT INTO vets VALUES(5,'Henry','Stevens');
INSERT INTO vets VALUES(6,'Sharon','Jenkins');
    </pre></div>
    
<p> into </p>
    
<div class="source">
<pre>
INSERT INTO vets VALUES(1);
INSERT INTO vets VALUES(2);
INSERT INTO vets VALUES(3);
INSERT INTO vets VALUES(4);
INSERT INTO vets VALUES(5);
INSERT INTO vets VALUES(6);
    </pre></div>
    
<p> Third we remove the names from the inserts into the table <i><tt>OWNERS</tt></i> and fix the
      indices. </p>
    
<p> Change </p>
    
<div class="source">
<pre>
INSERT INTO owners VALUES(1,'George','Franklin','110 W. Liberty St.','Madison','6085551023');
INSERT INTO owners VALUES(2,'Betty','Davis','638 Cardinal Ave.','Sun Prairie','6085551749');
INSERT INTO owners VALUES(3,'Eduardo','Rodriquez','2693 Commerce St.','McFarland','6085558763');
INSERT INTO owners VALUES(4,'Harold','Davis','563 Friendly St.','Windsor','6085553198');
INSERT INTO owners VALUES(5,'Peter','McTavish','2387 S. Fair Way','Madison','6085552765');
INSERT INTO owners VALUES(6,'Jean','Coleman','105 N. Lake St.','Monona','6085552654');
INSERT INTO owners VALUES(7,'Jeff','Black','1450 Oak Blvd.','Monona','6085555387');
INSERT INTO owners VALUES(8,'Maria','Escobito','345 Maple St.','Madison','6085557683');
INSERT INTO owners VALUES(9,'David','Schroeder','2749 Blackhawk Trail','Madison','6085559435');
INSERT INTO owners VALUES(10,'Carlos','Estaban','2335 Independence La.','Waunakee','6085555487');
    </pre></div>
    
<p> into </p>
    
<div class="source">
<pre>
INSERT INTO owners VALUES(7,'110 W. Liberty St.','Madison','6085551023');
INSERT INTO owners VALUES(8,'638 Cardinal Ave.','Sun Prairie','6085551749');
INSERT INTO owners VALUES(9,'2693 Commerce St.','McFarland','6085558763');
INSERT INTO owners VALUES(10,'563 Friendly St.','Windsor','6085553198');
INSERT INTO owners VALUES(11,'2387 S. Fair Way','Madison','6085552765');
INSERT INTO owners VALUES(12,'105 N. Lake St.','Monona','6085552654');
INSERT INTO owners VALUES(13,'1450 Oak Blvd.','Monona','6085555387');
INSERT INTO owners VALUES(14,'345 Maple St.','Madison','6085557683');
INSERT INTO owners VALUES(15,'2749 Blackhawk Trail','Madison','6085559435');
INSERT INTO owners VALUES(16,'2335 Independence La.','Waunakee','6085555487');
    </pre></div>
    
<p> Now we fix the owner-indices of the pets. </p>
    
<p> Change </p>
    
<div class="source">
<pre>
INSERT INTO pets VALUES(1,'Leo','2000-09-07',1,1);
INSERT INTO pets VALUES(2,'Basil','2002-08-06',6,2);
INSERT INTO pets VALUES(3,'Rosy','2001-04-17',2,3);
INSERT INTO pets VALUES(4,'Jewel','2000-03-07',2,3);
INSERT INTO pets VALUES(5,'Iggy','2000-11-30',3,4);
INSERT INTO pets VALUES(6,'George','2000-01-20',4,5);
INSERT INTO pets VALUES(7,'Samantha','1995-09-04',1,6);
INSERT INTO pets VALUES(8,'Max','1995-09-04',1,6);
INSERT INTO pets VALUES(9,'Lucky','1999-08-06',5,7);
INSERT INTO pets VALUES(10,'Mulligan','1997-02-24',2,8);
INSERT INTO pets VALUES(11,'Freddy','2000-03-09',5,9);
INSERT INTO pets VALUES(12,'Lucky','2000-06-24',2,10);
INSERT INTO pets VALUES(13,'Sly','2002-06-08',1,10);
    </pre></div>
    
<p> into </p>
    
<div class="source">
<pre>
INSERT INTO pets VALUES(1,'Leo','2000-09-07',1,7);
INSERT INTO pets VALUES(2,'Basil','2002-08-06',6,8);
INSERT INTO pets VALUES(3,'Rosy','2001-04-17',2,9);
INSERT INTO pets VALUES(4,'Jewel','2000-03-07',2,9);
INSERT INTO pets VALUES(5,'Iggy','2000-11-30',3,10);
INSERT INTO pets VALUES(6,'George','2000-01-20',4,11);
INSERT INTO pets VALUES(7,'Samantha','1995-09-04',1,12);
INSERT INTO pets VALUES(8,'Max','1995-09-04',1,12);
INSERT INTO pets VALUES(9,'Lucky','1999-08-06',5,13);
INSERT INTO pets VALUES(10,'Mulligan','1997-02-24',2,14);
INSERT INTO pets VALUES(11,'Freddy','2000-03-09',5,15);
INSERT INTO pets VALUES(12,'Lucky','2000-06-24',2,16);
INSERT INTO pets VALUES(13,'Sly','2002-06-08',1,16);
    </pre></div>
    
<p> Last we have to insert the credentials to log in the users. </p>
    
<p> Add </p>
    
<div class="source">
<pre>
INSERT INTO users VALUES(1,'james','b4cc344d25a2efe540adbf2678e2304c',1);
INSERT INTO users VALUES(2,'helen','7a2eb41a38a8f4e39c1586649da21e5f',2);
INSERT INTO users VALUES(3,'linda','eaf450085c15c3b880c66d0b78f2c041',3);
INSERT INTO users VALUES(4,'rafael','9135d8523ad3da99d8a4eb83afac13d1',4);
INSERT INTO users VALUES(5,'henry','027e4180beedb29744413a7ea6b84a42',5);
INSERT INTO users VALUES(6,'sharon','215a6517848319b70f3f450da480d888',6);
INSERT INTO users VALUES(7,'george','9b306ab04ef5e25f9fb89c998a6aedab',7);
INSERT INTO users VALUES(8,'betty','82b054bd83ffad9b6cf8bdb98ce3cc2f',8);
INSERT INTO users VALUES(9,'rod','52c59993d8e149a1d70b65cb08abf692',9);
INSERT INTO users VALUES(10,'harold','c57f431343f100b441e268cc12babc34',10);
INSERT INTO users VALUES(11,'peter','51dc30ddc473d43a6011e9ebba6ca770',11);
INSERT INTO users VALUES(12,'jean','b71985397688d6f1820685dde534981b',12);
INSERT INTO users VALUES(13,'jeff','166ee015c0e0934a8781e0c86a197c6e',13);
INSERT INTO users VALUES(14,'maria','263bce650e68ab4e23f28263760b9fa5',14);
INSERT INTO users VALUES(15,'david','172522ec1028ab781d9dfd17eaca4427',15);
INSERT INTO users VALUES(16,'carlos','dc599a9972fde3045dab59dbd1ae170b',16);
    </pre></div>
    
<p> The encoded passwords are the same as the appropriate user name. They may be changed later. </p>
  </div>
  
<div class="section">
<h2>     Adding the Authentication Model<a name="Adding_the_Authentication_Model"></a></h2>
    
<p> Now we add <tt>Credential.java</tt> in
        <tt>src/main/java/org/springframework/samples/petclinic/model</tt> with the following content. We
      implement the <i><tt>org.springframework.security.userdetails.UserDetails</tt></i> interface as later we
      will use Spring-Security for login. </p>
    
<div class="source">
<pre>
      
package org.springframework.samples.petclinic.model;


import java.util.Collections;
import java.util.List;

import javax.persistence.CascadeType;
import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.FetchType;
import javax.persistence.JoinColumn;
import javax.persistence.OneToOne;
import javax.persistence.Table;
import javax.persistence.Transient;

import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.GrantedAuthorityImpl;
import org.springframework.security.authentication.encoding.Md5PasswordEncoder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.util.StringUtils;

@Entity
@Table(name = &quot;users&quot;)
public class Credential extends BaseEntity implements UserDetails {

    private static final List&lt;GrantedAuthority&gt; USER_AUTHORITIES
        = Collections.&lt;GrantedAuthority&gt;singletonList(new GrantedAuthorityImpl(&quot;ROLE_USER&quot;));

    @Column(name = &quot;username&quot;)
    private String username;

    @Column(name = &quot;password&quot;)
    private String password;

    @OneToOne(cascade = CascadeType.ALL, fetch = FetchType.LAZY)
    @JoinColumn(name = &quot;person_id&quot;)
    private Person user;
    
    public String getUsername() {
        return username;
    }
    
    public void setUsername(String username) {
        this.username = username;
    }

    public String getPassword() {
        return password;
    }
    
    public void setPassword(String password) {
        this.password = password;
    }
    
    public String getNewPassword() {
        return &quot;new password&quot;;
    }
    
    @Transient
    public void setNewPassword(String password) {
        if (StringUtils.hasText(password)) {
            setPassword(new Md5PasswordEncoder().encodePassword(password, null));
        }
    }
    
    public Person getUser() {
        return user;
    }
    
    public void setUser(Person user) {
        this.user = user;
    }

    @Transient
    public List&lt;GrantedAuthority&gt; getAuthorities() {
        return USER_AUTHORITIES;
    }

    @Transient
    public boolean isEnabled() {
        return true;
    }

    @Transient
    public boolean isAccountNonExpired() {
        return true;
    }

    @Transient
    public boolean isAccountNonLocked() {
        return true;
    }

    @Transient
    public boolean isCredentialsNonExpired() {
        return true;
    }
    
    public boolean equals(Object object) {
        return object instanceof Credential? super.equals(object): false;
    }
}
      
    </pre></div>
    
<p> We change <tt>Person.java</tt> in
        <tt>src/main/java/org/springframework/samples/petclinic/model/</tt> to link to the credentials. </p>
    
<p>Change</p>
    
<div class="source">
<pre>
         
@MappedSuperclass
public class Person extends BaseEntity
    
    </pre></div>
    
<p>into</p>
    
<div class="source">
<pre>
          
@Entity
@Table(name = &quot;persons&quot;)
@Inheritance(strategy=InheritanceType.JOINED)
public class Person extends BaseEntity
    
    </pre></div>
    
<p> and add </p>
    
<div class="source">
<pre>
            
@OneToOne(cascade = CascadeType.ALL, mappedBy = &quot;user&quot;, fetch = FetchType.EAGER)
private Credential credential;

public Credential getCredential() {
    return credential;
}

public void setCredential(Credential credential) {
    this.credential = credential;
}
    
    </pre></div>
  </div>
  
<div class="section">
<h2>     Change the password<a name="Change_the_password"></a></h2>
    
<p> Our application is now able to store usernames and passwords, but there is no possibility to input or change
      it. </p>
    
<p> We modify the <tt>createOrUpdateOwnerForm.jsp</tt> (in <tt>src/main/webapp/WEB-INF/jsp/owners/</tt>) to
      achive both. We add the fields for username and password between the phone number and the buttons. </p>
    
<p> Change </p>
    
<div class="source">
<pre>
      
&lt;petclinic:inputField label=&quot;Telephone&quot; name=&quot;telephone&quot;/&gt;

&lt;div class=&quot;form-actions&quot;&gt;
    &lt;c:choose&gt;
        &lt;c:when test=&quot;${owner['new']}&quot;&gt;
            &lt;button type=&quot;submit&quot;&gt;Add Owner&lt;/button&gt;
        &lt;/c:when&gt;
        &lt;c:otherwise&gt;
            &lt;button type=&quot;submit&quot;&gt;Update Owner&lt;/button&gt;
        &lt;/c:otherwise&gt;
    &lt;/c:choose&gt;
&lt;/div&gt;

[...]

&lt;jsp:include page=&quot;../fragments/footer.jsp&quot;/&gt;        
      
    </pre></div>
    
<p> into </p>
    
<div class="source">
<pre>
      
&lt;petclinic:inputField label=&quot;Telephone&quot; name=&quot;telephone&quot;/&gt;

&lt;c:choose&gt;
    &lt;c:when test=&quot;${owner['new']}&quot;&gt;
        &lt;petclinic:inputField label=&quot;Username&quot; name=&quot;credential.username&quot;/&gt;
    &lt;/c:when&gt;
    &lt;c:otherwise&gt;
        Username: ${owner.credential.username}
    &lt;/c:otherwise&gt;
&lt;/c:choose&gt;

&lt;petclinic:inputField label=&quot;Password&quot; name=&quot;credential.newPassword&quot;/&gt;


&lt;div class=&quot;form-actions&quot;&gt;
    &lt;c:choose&gt;
        &lt;c:when test=&quot;${owner['new']}&quot;&gt;
            &lt;button type=&quot;submit&quot;&gt;Register Owner&lt;/button&gt;
        &lt;/c:when&gt;
        &lt;c:otherwise&gt;
            &lt;button type=&quot;submit&quot;&gt;Update Owner&lt;/button&gt;
        &lt;/c:otherwise&gt;
    &lt;/c:choose&gt;
&lt;/div&gt;

[...]

&lt;c:choose&gt;
    &lt;c:when test=&quot;${owner['new']}&quot;&gt;
        &lt;jsp:include page=&quot;../fragments/footer.jsp&quot;/&gt;
    &lt;/c:when&gt;
&lt;/c:choose&gt;
      
    </pre></div>
    
<p> Now we modify <tt>OwnerController.java</tt> (in
        <tt>src/main/java/org/springframework/samples/petclinic/web/</tt>) to actually store username and
      password. Change </p>
    
<div class="source">
<pre>
      
@RequestMapping(value = &quot;/owners/new&quot;, method = RequestMethod.GET)
public String initCreationForm(Model model) {
    Owner owner = new Owner();
    model.addAttribute(owner);
    return &quot;owners/createOrUpdateOwnerForm&quot;;
}
      
    </pre></div>
    
<p> into </p>
    
<div class="source">
<pre>
      
@RequestMapping(value = &quot;/owners/new&quot;, method = RequestMethod.GET)
public String initCreationForm(Model model) {
    Owner owner = new Owner();
    Credential credential = new Credential();
    owner.setCredential(credential);
    credential.setUser(owner);
    model.addAttribute(owner);
    model.addAttribute(credential); //This is for the pre-authentication filter later
    return &quot;owners/createOrUpdateOwnerForm&quot;;
}
      
    </pre></div>
    
<p> and </p>
    
<div class="source">
<pre>
      
@Controller
@SessionAttributes(types = Owner.class)
public class OwnerController {
    ...
}
      
    </pre></div>
    
<p> into </p>
    
<div class="source">
<pre>
      
@Controller
@SessionAttributes(&quot;owner&quot;)
public class OwnerController {
    ...
}
      
    </pre></div>
    
<p> and </p>
    
<div class="source">
<pre>
      
@InitBinder
public void setAllowedFields(WebDataBinder dataBinder) {
    dataBinder.setDisallowedFields(&quot;id&quot;);
}
      
    </pre></div>
    
<p> into </p>
    
<div class="source">
<pre>
      
@InitBinder
public void setAllowedFields(WebDataBinder dataBinder) {
    dataBinder.setDisallowedFields(&quot;id&quot;,&quot;username&quot;);
}
      
    </pre></div>
    
<p> Additionally we want to check that the user did not input an empty password (especially when the user is
      created, otherwise the current password can be taken), so we have to create the
        <tt>OwnerValidator.java</tt> (in
        <tt>src/main/java/org/springframework/samples/petclinic/web/</tt>). </p>
    
<p> Add the following code. </p>
    
<div class="source">
<pre>
      
package org.springframework.samples.petclinic.web;

import org.springframework.samples.petclinic.model.Owner;
import org.springframework.util.StringUtils;
import org.springframework.validation.Errors;

/**
 * &lt;code&gt;Validator&lt;/code&gt; for &lt;code&gt;Owner&lt;/code&gt; forms.
 *
 */
public class OwnerValidator {

    public void validate(Owner owner, Errors errors) {
        if (!StringUtils.hasLength(owner.getCredential().getUsername())) {
            errors.rejectValue(&quot;credential.username&quot;, &quot;required&quot;, &quot;required&quot;);
        }
        if (owner.getCredential().isNew() &amp;&amp; !StringUtils.hasLength(owner.getCredential().getPassword())) {
            errors.rejectValue(&quot;credential.newPassword&quot;, &quot;required&quot;, &quot;required&quot;);
        }
    }
}
      
    </pre></div>
  </div>
  
<div class="section">
<h2>       Change save-method<a name="Change_save-method"></a></h2>
      
<p>
      We have to change the <i><tt>save</tt></i>-method for owners because after registrating a new owner this owner should be login immediately. Therefore we need the new ids
      of this owner and of the belonging credential. So we have to change some code. In <tt>ClinicService.java</tt> (in 
      <tt>src/main/java/org/springframework/samples/petclinic/service/</tt>) change
      </p>
      
<div class="source">
<pre>
      
public void saveOwner(Owner owner) throws DataAccessException;
                
      </pre></div>
      
<p>into</p>
      
<div class="source">
<pre>
      
public Owner saveOwner(Owner owner) throws DataAccessException;
                
      </pre></div>
      
<p>So we have to change also the implementation of <tt>ClinicService</tt>. Change the following code in <tt>ClinicServiceImpl.java</tt>
          (in <tt>src/main/java/org/springframework/samples/petclinic/service/</tt>)
      </p>
      
<div class="source">
<pre>
      
@Override
@Transactional
public void saveOwner(Owner owner) throws DataAccessException {
    return ownerRepository.save(owner);
}
                
      </pre></div>
      
<p>into</p>
      
<div class="source">
<pre>
      
@Override
@Transactional
public Owner saveOwner(Owner owner) throws DataAccessException {
    return ownerRepository.save(owner);
}
                
      </pre></div>
      
<p>Now the repository of owners has to return a owner, when calling the <i><tt>save</tt></i>-method. Hence we change in <tt>OwnerRepository.java</tt> (in 
      <tt>src/main/java/org/springframework/samples/petclinic/repository/</tt>)
      </p>
      
<div class="source">
<pre>
      
/**
 * Save an &lt;code&gt;Owner&lt;/code&gt; to the data store, either inserting or updating it.
 *
 * @param owner the &lt;code&gt;Owner&lt;/code&gt; to save
 * @see BaseEntity#isNew
 */
void save(Owner owner) throws DataAccessException;
                
      </pre></div>
      
<p>into</p>
      
<div class="source">
<pre>
      
/**
 * Save an &lt;code&gt;Owner&lt;/code&gt; to the data store, either inserting or updating it.
 *
 * @param owner the &lt;code&gt;Owner&lt;/code&gt; to save
 * @return the &lt;code&gt;Owner&lt;/code&gt; which was saved
 * @see BaseEntity#isNew
 */
Owner save(Owner owner) throws DataAccessException;
                
      </pre></div>
      
<p>The last thing we do is to change the implementation of the repository for owners. Change the following code in <tt>JpaOwnerRepositoryImpl.java</tt> ( in
          <tt>src/main/java/org/springframework/samples/petclinic/repository/jpa/</tt>)</p>
      
<div class="source">
<pre>
      
@Override
public void save(Owner owner) {
    if (owner.getId() == null) {
        this.em.persist(owner);
    } else {
        this.em.merge(owner);
    }
}
                
      </pre></div>
      
<p>into</p>
      
<div class="source">
<pre>
      
@Override
public Owner save(Owner owner) {
    Owner merged = null;
    if(owner.getId() != null) {
    	Owner o = findById(owner.getId());
    	o.setFirstName(owner.getFirstName());
    	o.setLastName(owner.getLastName());
    	o.setAddress(owner.getAddress());
    	o.setCity(owner.getCity());
    	o.setTelephone(owner.getTelephone());
    	o.getCredential().setPassword(owner.getCredential().getNewPassword());
        merged = this.em.merge(o);
    } else {
    	merged = this.em.merge(owner);
    }
    this.em.flush();
    return merged;
}
      
      </pre></div>
  </div>
  
<div class="section">
<h2>     Integrating Spring Security<a name="Integrating_Spring_Security"></a></h2>
    
<p> We now need a simple login mechanism. Since we want to use Spring-Security, we create a credential-service
      that implements the <i><tt>org.springframework.security.userdetails.UserDetailsService</tt></i>
      interface. Before we add the credential-service, we first have to add a new repository for the credential. Therefore add the interface
      <tt>CredentialRepository.java</tt> in <tt>src/main/java/org/springframework/samples/petclinic/repository</tt>
      with the following content:</p>
      
<div class="source">
<pre>
      
package org.springframework.samples.petclinic.repository;

import org.jpasecurity.AccessType;

import org.springframework.dao.DataAccessException;
import org.springframework.samples.petclinic.model.Credential;

public interface CredentialRepository {

    Credential findById(int id) throws DataAccessException;

    Credential findByUsername(String username) throws DataAccessException; 

    boolean isAccessible(AccessType accessType, String entityName,Object... constructorArgs);
	
    boolean isAccessible(AccessType accessType, Object entity);
}
      
      </pre></div>
      
<p>The implementation of this interface, <tt>JpaCredentialRepositoryImpl.java</tt>, has to be added in 
          <tt>src/main/java/org/springframework/samples/petclinic/repository/jpa</tt> with the following content:</p>
      
<div class="source">
<pre>
      
package org.springframework.samples.petclinic.repository.jpa;

import javax.persistence.NoResultException;
import javax.persistence.PersistenceContext;
import javax.persistence.TypedQuery;

import org.jpasecurity.AccessType;
import org.jpasecurity.persistence.SecureEntityManager;

import org.springframework.dao.DataAccessException;
import org.springframework.samples.petclinic.model.Credential;
import org.springframework.samples.petclinic.repository.CredentialRepository;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Repository;

@Repository
public class JpaCredentialRepositoryImpl implements CredentialRepository{

    @PersistenceContext
    private SecureEntityManager em;

    @Override
    public Credential findById(int id) throws DataAccessException {
        TypedQuery&lt;Credential&gt; query = this.em.createQuery(&quot;SELECT credential FROM Credential credential &quot;
            + &quot; INNER JOIN FETCH credential.user&quot;
            + &quot; WHERE credential.id = :id&quot;, Credential.class);
        query.setParameter(&quot;id&quot;, id);
        return query.getSingleResult();
    }

    @Override
    public Credential findByUsername(String username) {
        try {
            TypedQuery&lt;Credential&gt; query = this.em.createQuery(&quot;SELECT credential FROM Credential credential &quot;
                + &quot;WHERE credential.username = :username&quot;, Credential.class);
            query.setParameter(&quot;username&quot;, username);
            return query.getSingleResult();
        } catch (NoResultException e) {
            throw new UsernameNotFoundException(username, e);
        }
    }

    @Override
    public boolean isAccessible(AccessType accessType, String entityName,
            Object... constructorArgs) {
        return this.em.isAccessible(accessType, entityName, constructorArgs);
    }

    @Override
    public boolean isAccessible(AccessType accessType, Object entity) {
        return this.em.isAccessible(accessType, entity);
    }
}
      
      </pre></div>
    
<p> We create now a package <i><tt>security</tt></i> (by creating the folder
        <tt>src/main/java/org/springframework/samples/petclinic/security/</tt>) and put the interface
        <tt>CredentialService.java</tt> into it. It extends <tt>UserDetailsService</tt>, so that
        the implementation of the interface has to implement it too.</p>
    
<p> The content of <tt>CredentialService.java</tt> follows: </p>
    
<div class="source">
<pre>
      
package org.springframework.samples.petclinic.security;

import org.jpasecurity.AccessManager;
import org.jpasecurity.AccessType;

import org.springframework.dao.DataAccessException;
import org.springframework.samples.petclinic.model.Credential;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;

public interface CredentialService extends UserDetailsService, AccessManager {

    public Credential loadUserByUsername(String username) throws UsernameNotFoundException, DataAccessException;

    public Credential findCredentialById(int id) throws DataAccessException;
	
    public boolean isAccessible(AccessType accessType, String entityName, Object... constructorArgs);

    public boolean isAccessible(AccessType accessType, Object entity);
}
      
    </pre></div>
    
<p>In the same package we create the implementation of <tt>CredentialService.java</tt>. Add <tt>CredentialServiceImpl.java</tt>
        in <tt>src/main/java/org/springframework/samples/petclinic/security/</tt>:</p>
      
<div class="source">
<pre>
      
package org.springframework.samples.petclinic.security;

import org.jpasecurity.AccessType;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.dao.DataAccessException;
import org.springframework.samples.petclinic.model.Credential;
import org.springframework.samples.petclinic.repository.CredentialRepository;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
public class CredentialServiceImpl implements CredentialService{

    private CredentialRepository credentialRepository;

    @Autowired
    public CredentialServiceImpl(CredentialRepository credentialRepository) {
        this.credentialRepository = credentialRepository;
    }

    @Transactional(readOnly = true)
    public Credential loadUserByUsername(String username) throws UsernameNotFoundException, DataAccessException{
        return credentialRepository.findByUsername(username);
    }

    @Transactional(readOnly = true)
    public Credential findCredentialById(int id) throws DataAccessException {
        return credentialRepository.findById(id);
    }

    @Transactional
    public boolean isAccessible(AccessType accessType, String entityName,
            Object... constructorArgs) {
        return credentialRepository.isAccessible(accessType, entityName, constructorArgs);
    }

    @Transactional
    public boolean isAccessible(AccessType accessType, Object entity) {
        return credentialRepository.isAccessible(accessType, entity);
    }
}
      
    </pre></div>     
    
<p> We add the security configuration to the Spring business configuration
        (<tt>src/main/resources/spring/business-config.xml</tt>). </p>
    
<p> First change </p>
    
<div class="source">
<pre>
      
&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
    xmlns:p=&quot;http://www.springframework.org/schema/p&quot; xmlns:context=&quot;http://www.springframework.org/schema/context&quot;
    xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot; xmlns:jpa=&quot;http://www.springframework.org/schema/data/jpa&quot;
    xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/data/jpa http://www.springframework.org/schema/data/jpa/spring-jpa.xsd
        http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd
        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd&quot;&gt;
      
    </pre></div>
    
<p> into </p>
    
<div class="source">
<pre>
      
&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
    xmlns:p=&quot;http://www.springframework.org/schema/p&quot; xmlns:context=&quot;http://www.springframework.org/schema/context&quot;
    xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot; xmlns:jpa=&quot;http://www.springframework.org/schema/data/jpa&quot;
    xmlns:sec=&quot;http://www.springframework.org/schema/security&quot;
    xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/data/jpa http://www.springframework.org/schema/data/jpa/spring-jpa.xsd
        http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd
        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
        http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-3.1.xsd&quot;&gt;
      
    </pre></div>
    
<p> Now change the following configuration of the <tt>business-config.xml</tt>. Change</p>
    
<div class="source">
<pre>
        
&lt;beans profile=&quot;default&quot;&gt;
    [...]
    &lt;bean class=&quot;org.springframework.dao.annotation.PersistenceExceptionTranslationPostProcessor&quot;/&gt;
&lt;/beans&gt;
    
    </pre></div>
     
<p>into</p>
    
<div class="source">
<pre>
      
&lt;beans profile=&quot;default&quot;&gt;
    [...]
    &lt;bean class=&quot;org.springframework.dao.annotation.PersistenceExceptionTranslationPostProcessor&quot;/&gt;

    &lt;sec:http pattern=&quot;/login&quot; security=&quot;none&quot;/&gt;
    &lt;sec:http auto-config=&quot;true&quot;&gt;
        &lt;sec:intercept-url pattern=&quot;/static/*&quot; access=&quot;IS_AUTHENTICATED_ANONYMOUSLY&quot; /&gt;
        &lt;sec:intercept-url pattern=&quot;/owners/new&quot; access=&quot;IS_AUTHENTICATED_ANONYMOUSLY&quot; /&gt;
        &lt;sec:intercept-url pattern=&quot;/**&quot; access=&quot;ROLE_USER&quot; /&gt;
        &lt;sec:form-login login-page=&quot;/login&quot; default-target-url=&quot;/&quot;/&gt;
        &lt;sec:logout /&gt;
    &lt;/sec:http&gt;

    &lt;sec:authentication-manager&gt;
        &lt;sec:authentication-provider user-service-ref=&quot;userService&quot;&gt;
          &lt;sec:password-encoder hash=&quot;md5&quot;/&gt;
        &lt;/sec:authentication-provider&gt;
    &lt;/sec:authentication-manager&gt;

    
    &lt;bean id=&quot;userService&quot; class=&quot;org.springframework.samples.petclinic.security.CredentialServiceImpl&quot; /&gt;
&lt;/beans&gt;
      
    </pre></div>
    
<p> With this configuration access to our pages is allowed only for users with the role
        <i><tt>ROLE_USER</tt></i> (which are all owners and vets). Only access to our login page and to our
      page to add owners is allowed for everyone. The latter is needed to enable new users to register. </p>
    
<p> Now we need a login page. We create the file <tt>login.jsp</tt> in
        <tt>src/main/webapp/WEB-INF/jsp/</tt> with the following content. </p>
    
<div class="source">
<pre>
      
&lt;!DOCTYPE html&gt; 
&lt;%@ page import=&quot;org.springframework.security.web.authentication.AbstractAuthenticationProcessingFilter&quot; %&gt;
&lt;%@ page import=&quot;org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter&quot; %&gt;
&lt;%@ page import=&quot;org.springframework.security.core.AuthenticationException&quot; %&gt;
&lt;%@ taglib prefix=&quot;c&quot; uri=&quot;http://java.sun.com/jsp/jstl/core&quot; %&gt;

&lt;html lang=&quot;en&quot;&gt;


&lt;jsp:include page=&quot;fragments/headTag.jsp&quot;/&gt;
&lt;jsp:include page=&quot;fragments/bodyHeader.jsp&quot;/&gt;
&lt;body&gt;
    &lt;div id=&quot;main&quot;&gt;
        &lt;form name=&quot;f&quot; action=&quot;&lt;c:url value='j_spring_security_check'/&gt;&quot; method=&quot;POST&quot;&gt;
            &lt;table&gt;
                &lt;tr&gt;&lt;td&gt;User:&lt;/td&gt;&lt;td&gt;&lt;input type='text' name='j_username' value='&lt;c:if test=&quot;${not empty param.login_error}&quot;&gt;&lt;c:out value=&quot;${SPRING_SECURITY_LAST_USERNAME}&quot;/&gt;&lt;/c:if&gt;'/&gt;&lt;/td&gt;&lt;/tr&gt;
                &lt;tr&gt;&lt;td&gt;Password:&lt;/td&gt;&lt;td&gt;&lt;input type='password' name='j_password'&gt;&lt;/td&gt;&lt;/tr&gt;
                &lt;tr&gt;&lt;td&gt;&lt;input type=&quot;checkbox&quot; name=&quot;_spring_security_remember_me&quot;&gt;&lt;/td&gt;&lt;td&gt;Don't ask for my password for two weeks&lt;/td&gt;&lt;/tr&gt;
          
                &lt;tr&gt;&lt;td colspan='2'&gt;&lt;p class=&quot;submit&quot;&gt;&lt;input name=&quot;submit&quot; type=&quot;submit&quot;&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;
                &lt;tr&gt;&lt;td colspan='2'&gt;&lt;p class=&quot;submit&quot;&gt;&lt;input name=&quot;reset&quot; type=&quot;reset&quot;&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;
            &lt;/table&gt;
      
        &lt;/form&gt;
    
        &lt;table class=&quot;footer&quot;&gt;
            &lt;tr&gt;
                &lt;td&gt;&lt;a href=&quot;&lt;c:url value=&quot;/owners/new&quot;/&gt;&quot;&gt;Register&lt;/a&gt;&lt;/td&gt;  
            &lt;/tr&gt;
        &lt;/table&gt;
    
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
      
    </pre></div>
    
<p> With this changes we now are able to log in any user. We now also can improve the creation of users: We are
      now able to check whether a username does already exist and we can automatically log in a newly created user. We
      have to inject the <i><tt>UserDetailsService</tt></i> we just created into the
      <i><tt>OwnerController</tt></i> (in
      <tt>src/main/java/org/springframework/samples/petclinic/web/OwnerController.java</tt>) </p>
    
<p> First we add an attribute <i><tt>UserDetailsService</tt></i> and inject it via the constructor.
      Change </p>
    
<div class="source">
<pre>
      
import java.util.Collection;

import javax.validation.Valid;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.samples.petclinic.model.Owner;
import org.springframework.samples.petclinic.model.Credential;
import org.springframework.samples.petclinic.service.ClinicService;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.WebDataBinder;
import org.springframework.web.bind.annotation.InitBinder;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.SessionAttributes;
import org.springframework.web.bind.support.SessionStatus;
import org.springframework.web.servlet.ModelAndView;

[...]

@Autowired
public OwnerController(ClinicService clinicService) {
    this.clinicService = clinicService;
}
      
    </pre></div>
    
<p> into </p>
    
<div class="source">
<pre>
      
import java.util.Collection;

import javax.validation.Valid;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.samples.petclinic.model.Owner;
import org.springframework.samples.petclinic.model.Credential;
import org.springframework.samples.petclinic.service.ClinicService;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.validation.BindingResult;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.web.bind.WebDataBinder;
import org.springframework.web.bind.annotation.InitBinder;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.SessionAttributes;
import org.springframework.web.bind.support.SessionStatus;
import org.springframework.web.servlet.ModelAndView;

[...]

private final UserDetailsService userDetailsService;

@Autowired
public OwnerController(ClinicService clinicService, UserDetailsService userDetailsService) {
    this.clinicService = clinicService;
    this.userDetailsService = userDetailsService;
}
      
    </pre></div>
    
<p> Now we can check, whether the username does already exist. In <i><tt>processCreationForm</tt></i> change </p>
    
<div class="source">
<pre>
      
@RequestMapping(value = &quot;/owners/new&quot;, method = RequestMethod.POST)
public String processCreationForm(@Valid Owner owner, BindingResult result, SessionStatus status) {
    if (result.hasErrors()) {
        return &quot;owners/createOrUpdateOwnerForm&quot;;
    } 
    ...
}
      
    </pre></div>
    
<p> into </p>
    
<div class="source">
<pre>
      
@RequestMapping(value = &quot;/owners/new&quot;, method = RequestMethod.POST)
public String processCreationForm(@Valid Owner owner, BindingResult result, SessionStatus status) {
    new OwnerValidator().validate(owner, result);
    try {
        userDetailsService.loadUserByUsername(owner.getCredential().getUsername());
        result.rejectValue(&quot;credential.username&quot;, &quot;alreadyExists&quot;, &quot;already exists&quot;);
    } catch (UsernameNotFoundException e) {
        //all right, the user does not already exist
    }
    if (result.hasErrors()) {
        return &quot;owners/createOrUpdateOwnerForm&quot;;
    } 
    ...
}
      
    </pre></div>
    
<p> To automatically log in the new user, modify the <i><tt>else</tt></i> block in
      <i><tt>processCreationForm</tt></i>. </p>
    
<p> Change </p>
    
<div class="source">
<pre>
      
else {
    this.clinicService.saveOwner(owner);
    status.setComplete();
    return &quot;redirect:/owners/&quot;+ owner.getId();
}
      
    </pre></div>
    
<p> into </p>
    
<div class="source">
<pre>
      
else {
    owner = this.clinicService.saveOwner(owner);
    Credential credential = owner.getCredential();
    Authentication authentication
      = new UsernamePasswordAuthenticationToken(credential, credential, credential.getAuthorities());
    SecurityContextHolder.getContext().setAuthentication(authentication);
    status.setComplete();
    return &quot;redirect:/&quot;;
}
      
    </pre></div>
    
<p> When we are logged in we would expect a personal greeting and a direct link to our pets. </p>
    
<p> For this we create the file <tt>ClinicController.java</tt> in
        (<tt>src/main/java/org/springframework/samples/petclinic/web/</tt>). </p>
    
<div class="source">
<pre>
      
package org.springframework.samples.petclinic.web;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.samples.petclinic.model.Credential;
import org.springframework.samples.petclinic.model.Owner;
import org.springframework.samples.petclinic.model.Person;
import org.springframework.samples.petclinic.model.Vet;
import org.springframework.samples.petclinic.security.CredentialService;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.servlet.ModelAndView;

@Controller
public class ClinicController {

    private final CredentialService credentialService;

    @Autowired
    public ClinicController(CredentialService credentialService) {
        this.credentialService = credentialService;
    }

    /**
     * Custom handler for the welcome view.
     * &lt;p&gt;
     * Note that this handler relies on the RequestToViewNameTranslator to
     * determine the logical view name based on the request URL: &quot;/welcome.do&quot;
     * -&amp;gt; &quot;welcome&quot;.
     */
    @RequestMapping(&quot;/login&quot;)
    public String loginHandler() {
        return &quot;login&quot;;
    }
    
    /**
     * Custom handler for the welcome view.
     * &lt;p&gt;
     * Note that this handler relies on the RequestToViewNameTranslator to
     * determine the logical view name based on the request URL: &quot;/welcome.do&quot;
     * -&amp;gt; &quot;welcome&quot;.
     */
    @RequestMapping(&quot;/&quot;)
    public ModelAndView welcomeHandler() {
        Credential credential = (Credential)SecurityContextHolder.getContext().getAuthentication().getPrincipal();
        ModelAndView mav = new ModelAndView(&quot;welcome&quot;);
        Person user = credentialService.findCredentialById(credential.getId()).getUser();
        mav.addObject(&quot;person&quot;, user);
        mav.addObject(&quot;vet&quot;, user instanceof Vet);
        mav.addObject(&quot;owner&quot;, user instanceof Owner);
        return mav;
    }
}
      
    </pre></div>
    
<p> Now we delete the following data from <tt>bodyHeader.jsp</tt> (from
      <tt>src/main/webapp/WEB-INF/jsp/fragments/</tt>). </p>
    
<div class="source">
<pre>
      
&lt;div class=&quot;navbar&quot; style=&quot;width: 601px;&quot;&gt;
    &lt;div class=&quot;navbar-inner&quot;&gt;
        &lt;ul class=&quot;nav&quot;&gt;
            &lt;li style=&quot;width: 100px;&quot;&gt;&lt;a href=&quot;&lt;spring:url value=&quot;/&quot; htmlEscape=&quot;true&quot; /&gt;&quot;&gt;&lt;i class=&quot;icon-home&quot;&gt;&lt;/i&gt;
                Home&lt;/a&gt;&lt;/li&gt;
            &lt;li style=&quot;width: 130px;&quot;&gt;&lt;a href=&quot;&lt;spring:url value=&quot;/owners/find.html&quot; htmlEscape=&quot;true&quot; /&gt;&quot;&gt;&lt;i
                    class=&quot;icon-search&quot;&gt;&lt;/i&gt; Find owners&lt;/a&gt;&lt;/li&gt;
            &lt;li style=&quot;width: 140px;&quot;&gt;&lt;a href=&quot;&lt;spring:url value=&quot;/vets.html&quot; htmlEscape=&quot;true&quot; /&gt;&quot;&gt;&lt;i
                    class=&quot;icon-th-list&quot;&gt;&lt;/i&gt; Veterinarians&lt;/a&gt;&lt;/li&gt;
            &lt;li style=&quot;width: 90px;&quot;&gt;&lt;a href=&quot;&lt;spring:url value=&quot;/oups.html&quot; htmlEscape=&quot;true&quot; /&gt;&quot;
                                        title=&quot;trigger a RuntimeException to see how it is handled&quot;&gt;&lt;i
                    class=&quot;icon-warning-sign&quot;&gt;&lt;/i&gt; Error&lt;/a&gt;&lt;/li&gt;
            &lt;li style=&quot;width: 80px;&quot;&gt;&lt;a href=&quot;#&quot; title=&quot;not available yet. Work in progress!!&quot;&gt;&lt;i
                    class=&quot; icon-question-sign&quot;&gt;&lt;/i&gt; Help&lt;/a&gt;&lt;/li&gt;
        &lt;/ul&gt;
    &lt;/div&gt;
&lt;/div&gt;
      
    </pre></div>
    
<p> Now we can change <tt>welcome.jsp</tt> (from
        <tt>src/main/webapp/WEB-INF/jsp/</tt>). </p>
    
<p> Change </p>
    
<div class="source">
<pre>
      
&lt;%@ taglib prefix=&quot;spring&quot; uri=&quot;http://www.springframework.org/tags&quot; %&gt;
&lt;%@ taglib prefix=&quot;fmt&quot; uri=&quot;http://java.sun.com/jsp/jstl/fmt&quot; %&gt;

[...]

    &lt;h2&gt;&lt;fmt:message key=&quot;welcome&quot;/&gt;&lt;/h2&gt;
    &lt;spring:url value=&quot;/resources/images/pets.png&quot; htmlEscape=&quot;true&quot; var=&quot;petsImage&quot;/&gt;
    &lt;img src=&quot;${petsImage}&quot;/&gt;
      
    </pre></div>
    
<p> into </p>
    
<div class="source">
<pre>
      
&lt;%@ taglib prefix=&quot;spring&quot; uri=&quot;http://www.springframework.org/tags&quot; %&gt;
&lt;%@ taglib prefix=&quot;fmt&quot; uri=&quot;http://java.sun.com/jsp/jstl/fmt&quot; %&gt;
&lt;%@ taglib prefix=&quot;fn&quot; uri=&quot;http://java.sun.com/jsp/jstl/functions&quot; %&gt;
&lt;%@ taglib prefix=&quot;c&quot; uri=&quot;http://java.sun.com/jsp/jstl/core&quot; %&gt;
[...]
&lt;ul class=&quot;nav&quot;&gt;
    &lt;c:choose&gt;
        &lt;c:when test=&quot;${vet}&quot;&gt;
            &lt;li&gt;
                &lt;spring:url value=&quot;/vets/{vetId}&quot; var=&quot;vetsUrl&quot;&gt;
                    &lt;spring:param name=&quot;vetId&quot; value=&quot;${person.id}&quot;/&gt;
                &lt;/spring:url&gt;
                &lt;a href=&quot;${fn:escapeXml(vetsUrl)}&quot;&gt;Personal information&lt;/a&gt;
            &lt;/li&gt;
            &lt;li style=&quot;width: 130px;&quot;&gt;&lt;a href=&quot;&lt;spring:url value=&quot;/owners/find.html&quot; htmlEscape=&quot;true&quot; /&gt;&quot;&gt;&lt;i
                    class=&quot;icon-search&quot;&gt;&lt;/i&gt; Find owners&lt;/a&gt;&lt;/li&gt;
        &lt;/c:when&gt;
        &lt;c:when test=&quot;${owner}&quot;&gt;
            &lt;p&gt;&amp;nbsp;&lt;/p&gt;
            &lt;li&gt;          
                &lt;spring:url value=&quot;/owners/{ownerId}&quot; var=&quot;ownerUrl&quot;&gt;
                    &lt;spring:param name=&quot;ownerId&quot; value=&quot;${person.id}&quot;/&gt;
                &lt;/spring:url&gt;
                &lt;a href=&quot;${fn:escapeXml(ownerUrl)}&quot;&gt;Personal information &lt;/a&gt;
            &lt;/li&gt;
        &lt;/c:when&gt;
     &lt;/c:choose&gt;
     &lt;li style=&quot;width: 140px;&quot;&gt;&lt;a href=&quot;&lt;spring:url value=&quot;/vets.html&quot; htmlEscape=&quot;true&quot; /&gt;&quot;&gt;
        &lt;i class=&quot;icon-th-list&quot;&gt;&lt;/i&gt; Veterinarians&lt;/a&gt;&lt;/li&gt;
     &lt;li style=&quot;width: 90px;&quot;&gt;&lt;a href=&quot;&lt;spring:url value=&quot;/oups.html&quot; htmlEscape=&quot;true&quot; /&gt;&quot;
                                    title=&quot;trigger a RuntimeException to see how it is handled&quot;&gt;
        &lt;i class=&quot;icon-warning-sign&quot;&gt;&lt;/i&gt; Error&lt;/a&gt;&lt;/li&gt;
     &lt;li style=&quot;width: 80px;&quot;&gt;&lt;a href=&quot;#&quot; title=&quot;not available yet. Work in progress!!&quot;&gt;
        &lt;i class=&quot; icon-question-sign&quot;&gt;&lt;/i&gt; Help&lt;/a&gt;&lt;/li&gt;
  &lt;/ul&gt;
&lt;h2&gt;&lt;fmt:message key=&quot;welcome&quot;/&gt; ${person.firstName} ${person.lastName}&lt;/h2&gt;
      
    </pre></div>
    
<p> You also may add a logout-link to every page by modifying <tt>footer.jsp</tt> (from
        <tt>src/main/webapp/WEB-INF/jsp/fragments/</tt>). </p>
    
<p> Change </p>
    
<div class="source">
<pre>
      
&lt;td align=&quot;right&quot;&gt;&lt;img src=&quot;&lt;spring:url value=&quot;/resources/images/springsource-logo.png&quot; htmlEscape=&quot;true&quot; /&gt;&quot;
                         alt=&quot;Sponsored by SpringSource&quot;/&gt;&lt;/td&gt;
      
    </pre></div>
    
<p> into </p>
    
<div class="source">
<pre>
      
&lt;td align=&quot;right&quot;&gt;&lt;a href='&lt;spring:url value=&quot;/j_spring_security_logout&quot;/&gt;'&gt;Logout&lt;/a&gt;&lt;/td&gt;
      
    </pre></div>
    
<p> The last thing we have to do is to add the Spring-Security filter to our <tt>web.xml</tt> (in
        <tt>src/main/webapp/WEB-INF/</tt>). </p>
    
<p> Add </p>
    
<div class="source">
<pre>
      
&lt;filter&gt;
    &lt;filter-name&gt;springSecurityFilterChain&lt;/filter-name&gt;
    &lt;filter-class&gt;org.springframework.web.filter.DelegatingFilterProxy&lt;/filter-class&gt;
&lt;/filter&gt;

&lt;filter-mapping&gt;
    &lt;filter-name&gt;springSecurityFilterChain&lt;/filter-name&gt;
    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
&lt;/filter-mapping&gt;
      
    </pre></div>
    
<p> When you now start the application you have to login to access the pages. Remember the login data we have put
      into the database (the password was the same as the username) or use the <a class="externalLink" href="http://localhost:9966/petclinic/owners/new">Register</a> link from the
      login-page to register a new owner. </p>
  </div>

<div class="section">
<h2></h2><hr /><!-- Navigation Panel -->
<table class="bodyTable" width="100%" align="center" border="0">
<tr class="a">
<td align="left">Previous: <a href="model.html">Domain Model</a></td>
<td align="center">Up: <a href="tutorial.html">Tutorial</a></td>
<td align="right">Next: <a href="authorization.html">Authorization</a></td></tr></table><!-- End of Navigation Panel --></div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
              Copyright &#169;                   2019.
          All Rights Reserved.      
                    
                  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
