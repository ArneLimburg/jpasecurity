<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia Site Renderer 1.4 at 2019-07-31 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>JPA Security - 
  Adding Security</title>
    <style type="text/css" media="all">
      @import url("../css/maven-base.css");
      @import url("../css/maven-theme.css");
      @import url("../css/site.css");
    </style>
    <link rel="stylesheet" href="../css/print.css" type="text/css" media="print" />
    <meta name="Date-Revision-yyyymmdd" content="20190731" />
    <meta http-equiv="Content-Language" content="en" />
        
        </head>
  <body class="composite">
    <div id="banner">
                    <div id="bannerLeft">
                
                </div>
                          <div id="bannerRight">
                                                <img src="../images/logo.png" alt="$alt" />
                </div>
            <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
                    
                <div class="xleft">
        <span id="publishDate">Last Published: 2019-07-31</span>
                      </div>
            <div class="xright">        
                    
                 <span id="projectVersion">Version: 1.0.0-SNAPSHOT</span>
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
                    
                                <h5>JPA Security</h5>
                  <ul>
                  <li class="none">
                          <a href="../index.html" title="Introduction">Introduction</a>
            </li>
                  <li class="none">
                          <a href="https://sourceforge.net/project/showfiles.php?group_id=219346" class="externalLink" title="Download">Download</a>
            </li>
                                                                                                                    <li class="expanded">
                          <a href="../project-doc.html" title="Documentation">Documentation</a>
                    <ul>
                      <li class="none">
                          <a href="../reference/preface.html" title="Reference Manual">Reference Manual</a>
            </li>
                      <li class="none">
                          <a href="../simple-tutorial/introduction.html" title="Simple Tutorial">Simple Tutorial</a>
            </li>
                      <li class="none">
                          <a href="../petclinic-tutorial/introduction.html" title="Petclinic Tutorial">Petclinic Tutorial</a>
            </li>
                      <li class="none">
                          <a href="../elearning-sample/introduction.html" title="E-Learning Sample">E-Learning Sample</a>
            </li>
              </ul>
        </li>
          </ul>
                       <h5>Project Documentation</h5>
                  <ul>
                                                                                                                                                                                                                                      <li class="collapsed">
                          <a href="../project-info.html" title="Project Information">Project Information</a>
                  </li>
                                                                                                        <li class="collapsed">
                          <a href="../project-reports.html" title="Project Reports">Project Reports</a>
                  </li>
          </ul>
                                                                                                                                     <a href="http://maven.apache.org/" title="Build with Maven 2" class="poweredBy">
        <img class="poweredBy"  alt="Build with Maven 2" src="../images/logos/maven-feather.png"     />
      </a>
                                                                                                                <a href="http://sourceforge.net/donate/index.php?group_id=219346" title="Donate" class="poweredBy">
        <img class="poweredBy"  alt="Donate" src="http://images.sourceforge.net/images/project-support.jpg"     />
      </a>
                                                                                                                <a href="http://sourceforge.net" title="Hosted on SourceForge.net" class="poweredBy">
        <img class="poweredBy"  alt="Hosted on SourceForge.net" src="http://sflogo.sourceforge.net/sflogo.php?group_id=219346&type=9"     />
      </a>
                       
                    
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <div class="section">
<h2></h2><!-- Navigation Panel -->
<table class="bodyTable" width="100%" align="center" border="0">
<tr class="a">
<td align="left">Previous: <a href="test-data.html">Test Data</a></td>
<td align="center">Up: <a href="tutorial.html">Tutorial</a></td>
<td align="right"><i>End of book</i></td></tr></table><!-- End of Navigation Panel --><hr /></div>
<p>
    In order to add access-control to our application we first need to integrate JPA Security.
  </p>
  
<div class="section">
<h2>     Integrating JPA Security<a name="Integrating_JPA_Security"></a></h2>
    
<p>
      Integrating JPA Security is as simple as configuring the persistence provider:
    </p>
    
<div class="source">
<pre>
      
&lt;persistence-unit name=&quot;contacts&quot; transaction-type=&quot;RESOURCE_LOCAL&quot;&gt;

  &lt;provider&gt;org.jpasecurity.persistence.SecurePersistenceProvider&lt;/provider&gt;

  &lt;class&gt;org.jpasecurity.contacts.model.User&lt;/class&gt;
  &lt;class&gt;org.jpasecurity.contacts.model.Contact&lt;/class&gt;

  &lt;properties&gt;
    &lt;property name=&quot;org.jpasecurity.persistence.provider&quot; value=&quot;org.hibernate.ejb.HibernatePersistence&quot; /&gt;
    &lt;property name=&quot;org.jpasecurity.security.authentication.provider&quot; value=&quot;org.jpasecurity.security.authentication.StaticAuthenticationProvider&quot;/&gt;
    &lt;property name=&quot;hibernate.hbm2ddl.auto&quot; value=&quot;create-drop&quot; /&gt;
    &lt;property name=&quot;hibernate.dialect&quot; value=&quot;org.hibernate.dialect.HSQLDialect&quot; /&gt;
    &lt;property name=&quot;hibernate.connection.driver_class&quot; value=&quot;org.hsqldb.jdbcDriver&quot; /&gt;
    &lt;property name=&quot;hibernate.connection.url&quot; value=&quot;jdbc:hsqldb:mem:contacts&quot; /&gt;
    &lt;property name=&quot;hibernate.connection.username&quot; value=&quot;sa&quot; /&gt;
    &lt;property name=&quot;hibernate.connection.password&quot; value=&quot;&quot; /&gt;
  &lt;/properties&gt;

&lt;/persistence-unit&gt;
      
    </pre></div>
    
<p>
      The following line has changed in order to use JPA Security:
    </p>
    
<div class="source">
<pre>
      
&lt;provider&gt;org.jpasecurity.persistence.SecurePersistenceProvider&lt;/provider&gt;
      
    </pre></div>
    
<p>
      The following line is added to specify the persistence provider:
    </p>
    
<div class="source">
<pre>
      
    &lt;property name=&quot;org.jpasecurity.persistence.provider&quot; value=&quot;org.hibernate.ejb.HibernatePersistence&quot; /&gt;
    &lt;property name=&quot;org.jpasecurity.security.authentication.provider&quot; value=&quot;org.jpasecurity.security.authentication.StaticAuthenticationProvider&quot;/&gt;
      
    </pre></div>
    
<p>
      OK, let's run our program again and let's see what happens...
    </p>
    
<p>
      As you can see from the output: nothing happend, everything stayed as before.
      JPA Security smoothly integrated into our application, we even can't see it work.
      We have not defined access rules for now.
    </p>
  </div>
  
<div class="section">
<h2>     Defining access rules<a name="Defining_access_rules"></a></h2>
    
<p>
      We define access rules by annotating our domain objects:
    </p>
    
<div class="source">
<pre>
      
import javax.annotation.security.DeclareRoles;
import javax.annotation.security.RolesAllowed;
import org.jpasecurity.security.Permit;
      
@Entity
@DeclareRoles({&quot;admin&quot;, &quot;user&quot;})
@RolesAllowed(&quot;admin&quot;)
@Permit(rule = &quot;name = CURRENT_PRINCIPAL&quot;)
public class User {
    ...
}
      
    </pre></div>
    
<div class="source">
<pre>
      
import javax.annotation.security.RolesAllowed;
import org.jpasecurity.security.Permit;

@Entity
@RolesAllowed(&quot;admin&quot;)
@Permit(rule = &quot;owner.name = CURRENT_PRINCIPAL&quot;)
public class Contact {
    ...
}
      
    </pre></div>
    
<p>
      We have added three annotations to <i><tt>User</tt></i> and two annotations to <i><tt>Contact</tt></i>:
    </p>
    
<ul>
      
<li>
        
          <i><tt>@DeclareRoles({&quot;admin&quot;, &quot;user&quot;})</tt></i>
          This annotation tells JPA Security that we are going to use the roles &quot;admin&quot; and &quot;user&quot;.
          We must declare these roles at least at one entity.
        
      </li>
      
<li>
        
          <i><tt>@RolesAllowed(&quot;admin&quot;)</tt></i>
          This annotation was added to both classes. With it we specify that every user
          that is in the role admin may create, read, update or delete entities of the types
          <i><tt>User</tt></i> and <i><tt>Contact</tt></i>.
        
      </li>
      
<li>
        
          <i><tt>@Permit(rule = &quot;name = CURRENT_PRINCIPAL&quot;)</tt></i>
          We annotated only the <i><tt>User</tt></i> class with this annotation. It specifies,
          that access to a <i><tt>User</tt></i> is permitted when the name of the user is the
          same as the current principal. In other words: Every user may access its own
          <i><tt>User</tt></i> object.
        
      </li>
      
<li>
        
          <i><tt>@Permit(rule = &quot;owner.name = CURRENT_PRINCIPAL&quot;)</tt></i>
          This annotation was added only to the <i><tt>Contact</tt></i> class.
          We specify, that access to a <i><tt>Contact</tt></i> is permitted when the name
          of the owner is the same as the current principal. In other words: Every user
          may access its own <i><tt>Contact</tt></i> objects.
        
      </li>
    </ul>
    
<p>      
      These access rules that show the capability of JPA Security. We have specified,
      that a <i><tt>User</tt></i> object may be accessed either by an admin or by the user
      represented by that object. For the <i><tt>Contact</tt></i> objects we have specified
      that they may be accessed by admins, too and that they may be accessed by their owners.
    </p>
    
<p>
      Let's execute our program now and see what happens...
    </p>
    
<p>
      As we can see an exception is thrown, a <i><tt>java.lang.SecurityException</tt></i>
      at the line where we try to persist the user john. That's great. We should have expected this,
      as we are not authenticated and thus are not permitted to save any user. 
    </p>
  </div>
  
<div class="section">
<h2>     Using runAs<a name="Using_runAs"></a></h2>
    
<p>
      Apparently we need admin rights to create users, that means we must
      run the <i><tt>createUsers</tt></i> method as admin. We can to this by using the <i><tt>runAs</tt></i>
      method of the <i><tt>StaticAuthenticationProvider</tt></i>. We change the method <i><tt>createUsers</tt></i>
      to run as user &quot;root&quot; with the role &quot;admin&quot;:
    </p>
    
<div class="source">
<pre>
      
  public static void createUsers(final EntityManagerFactory entityManagerFactory) {
    StaticAuthenticationProvider.runAs(&quot;root&quot;, Arrays.asList(&quot;admin&quot;), new PrivilegedAction() {
      public Object run() {
        EntityManager entityManager;

        entityManager = entityManagerFactory.createEntityManager();
        entityManager.getTransaction().begin();
        entityManager.persist(new User(&quot;John&quot;));
        entityManager.persist(new User(&quot;Mary&quot;));
        entityManager.getTransaction().commit();
        entityManager.close();
        return null;
      }
    });
  }
      
    </pre></div>
    
<p>
      Now let's execute our program again and see what happens now...
    </p>
    
<p>
      Another exception is thrown, this time it is a <i><tt>javax.persistence.NoResultException</tt></i>
      at the line where we try to select john from the database. That's good news.
      We are just authenticated during the method <i><tt>createUsers</tt></i>.
      So when we try to create the contacts, we are not authenticated thus not permitted to select john from the database.
      This means, JPA Security works. An additional output proves this, as we can see the number of users we get displayed
	  by our <i><tt>displayUserCount</tt></i> method is actually 0.
	  JPA Security filters out the users we are not permitted to see (which are all). 
    </p>
    
<p>
      We are now using <i><tt>runAs</tt></i> to create the contacts, too:
    </p>
    
<div class="source">
<pre>
      
  public static void createContacts(final EntityManagerFactory entityManagerFactory) {
    StaticAuthenticationProvider.runAs(&quot;root&quot;, Arrays.asList(&quot;admin&quot;), new PrivilegedAction() {
      public Object run() {
        EntityManager entityManager;

        entityManager = entityManagerFactory.createEntityManager();
        entityManager.getTransaction().begin();
        User john = (User)entityManager.createQuery(&quot;SELECT user FROM User user WHERE user.name = 'John'&quot;).getSingleResult();
        User mary = (User)entityManager.createQuery(&quot;SELECT user FROM User user WHERE user.name = 'Mary'&quot;).getSingleResult();
        entityManager.persist(new Contact(john, &quot;peter@jpasecurity.sf.net&quot;));
        entityManager.persist(new Contact(john, &quot;0 12 34 - 56 789&quot;));
        entityManager.persist(new Contact(mary, &quot;paul@jpasecurity.sf.net&quot;));
        entityManager.persist(new Contact(mary, &quot;12 34 56 78 90&quot;));
        entityManager.getTransaction().commit();
        entityManager.close();
        return null;
      }
    });
  }
      
    </pre></div>
  </div>
  
<div class="section">
<h2>     Authentication<a name="Authentication"></a></h2>
    
<p>
      When we now run the application, we see that the exceptions are gone away. When we take a look at
      the output of our <i><tt>displayUserCount</tt></i> and <i><tt>displayContactCount</tt></i> methods,
      we see that it is actually 0.
      We should have expected this since we just authenticated for the <i><tt>createXXX</tt></i> methods.
      Let's authenticate as &quot;root&quot; with the role admin at the beginning of the <i><tt>main</tt></i> method:
    </p>
    
<div class="source">
<pre>
      
  public static void main(String[] args) {
    StaticAuthenticationProvider.authenticate(&quot;root&quot;, &quot;admin&quot;);
    EntityManagerFactory entityManagerFactory = Persistence.createEntityManagerFactory(&quot;contacts&quot;);
    createUsers(entityManagerFactory);
    displayUserCount(entityManagerFactory);
    createContacts(entityManagerFactory);
    displayContactCount(entityManagerFactory);
  }
      
    </pre></div>
    
<p>
      When we now execute our program we can see from the output, that we get 2 users and 4 contacts.
      This is what we expected, as we are permitted to select all data with the role &quot;admin&quot;.
    </p>
    
<p>
      But what is, when we authenticate as &quot;John&quot;? Let's try...
    </p>
    
<div class="source">
<pre>
      
  public static void main(String[] args) {
    StaticAuthenticationProvider.authenticate(&quot;John&quot;);
    EntityManagerFactory entityManagerFactory = Persistence.createEntityManagerFactory(&quot;contacts&quot;);
    createUsers(entityManagerFactory);
    displayUserCount(entityManagerFactory);
    createContacts(entityManagerFactory);
    displayContactCount(entityManagerFactory);
  }
      
    </pre></div>
    
<p>
      Now the output says that we get 1 user and 2 contacts (that are Johns contacts). We get only one
      user because we are only allowed to retrieve our own <i><tt>User</tt></i> object.
      Obviously JPA Security works: It filters out the users and contacts we are not allowed to see.
      We may authenticate as &quot;Mary&quot; and see that it works, too.
    </p>
    
<p>
      Congratulations, you have successfully set up and worked with JPA Security.
      Next steps may be to read the manual, try the petclinic tutorial or take a look at the API-Documentation.
    </p>
  </div>

<div class="section">
<h2></h2><hr /><!-- Navigation Panel -->
<table class="bodyTable" width="100%" align="center" border="0">
<tr class="a">
<td align="left">Previous: <a href="test-data.html">Test Data</a></td>
<td align="center">Up: <a href="tutorial.html">Tutorial</a></td>
<td align="right"><i>End of book</i></td></tr></table><!-- End of Navigation Panel --></div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
              Copyright &#169;                   2019.
          All Rights Reserved.      
                    
                  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
