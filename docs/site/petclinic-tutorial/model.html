<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia Site Renderer 1.4 at 2019-07-31 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>JPA Security - 
  Domain Model</title>
    <style type="text/css" media="all">
      @import url("../css/maven-base.css");
      @import url("../css/maven-theme.css");
      @import url("../css/site.css");
    </style>
    <link rel="stylesheet" href="../css/print.css" type="text/css" media="print" />
    <meta name="Date-Revision-yyyymmdd" content="20190731" />
    <meta http-equiv="Content-Language" content="en" />
        
        </head>
  <body class="composite">
    <div id="banner">
                    <div id="bannerLeft">
                
                </div>
                          <div id="bannerRight">
                                                <img src="../images/logo.png" alt="$alt" />
                </div>
            <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
                    
                <div class="xleft">
        <span id="publishDate">Last Published: 2019-07-31</span>
                      </div>
            <div class="xright">        
                    
                 <span id="projectVersion">Version: 1.0.0-SNAPSHOT</span>
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
                    
                                <h5>JPA Security</h5>
                  <ul>
                  <li class="none">
                          <a href="../index.html" title="Introduction">Introduction</a>
            </li>
                  <li class="none">
                          <a href="https://sourceforge.net/project/showfiles.php?group_id=219346" class="externalLink" title="Download">Download</a>
            </li>
                                                                                                                    <li class="expanded">
                          <a href="../project-doc.html" title="Documentation">Documentation</a>
                    <ul>
                      <li class="none">
                          <a href="../reference/preface.html" title="Reference Manual">Reference Manual</a>
            </li>
                      <li class="none">
                          <a href="../simple-tutorial/introduction.html" title="Simple Tutorial">Simple Tutorial</a>
            </li>
                      <li class="none">
                          <a href="../petclinic-tutorial/introduction.html" title="Petclinic Tutorial">Petclinic Tutorial</a>
            </li>
                      <li class="none">
                          <a href="../elearning-sample/introduction.html" title="E-Learning Sample">E-Learning Sample</a>
            </li>
              </ul>
        </li>
          </ul>
                       <h5>Project Documentation</h5>
                  <ul>
                                                                                                                                                                                                                                      <li class="collapsed">
                          <a href="../project-info.html" title="Project Information">Project Information</a>
                  </li>
                                                                                                        <li class="collapsed">
                          <a href="../project-reports.html" title="Project Reports">Project Reports</a>
                  </li>
          </ul>
                                                                                                                                     <a href="http://maven.apache.org/" title="Build with Maven 2" class="poweredBy">
        <img class="poweredBy"  alt="Build with Maven 2" src="../images/logos/maven-feather.png"     />
      </a>
                                                                                                                <a href="http://sourceforge.net/donate/index.php?group_id=219346" title="Donate" class="poweredBy">
        <img class="poweredBy"  alt="Donate" src="http://images.sourceforge.net/images/project-support.jpg"     />
      </a>
                                                                                                                <a href="http://sourceforge.net" title="Hosted on SourceForge.net" class="poweredBy">
        <img class="poweredBy"  alt="Hosted on SourceForge.net" src="http://sflogo.sourceforge.net/sflogo.php?group_id=219346&type=9"     />
      </a>
                       
                    
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <div class="section">
<h2></h2><!-- Navigation Panel -->
<table class="bodyTable" width="100%" align="center" border="0">
<tr class="a">
<td align="left">Previous: <a href="tutorial.html">Tutorial</a></td>
<td align="center">Up: <a href="tutorial.html">Tutorial</a></td>
<td align="right">Next: <a href="authentication.html">Authentication</a></td></tr></table><!-- End of Navigation Panel --><hr /></div>
<p> When you click around in the application and find everything working, you will recognize that most of our
    requirements are already met by the application: </p>
  
<ol style="list-style-type: decimal">
    
<li>
      You are able to create owners of pets
    </li>
    
<li>
      You are able to add and edit their pets
    </li>
    
<li>
      You are able to add visits for the owners
    </li>
  </ol>
  
<p> The only thing that is really missing from the requirements is the ability to assign visits to vets. In this
    chapter we are going to realize this. </p>
  
<div class="section">
<h2>     Modifying the Database<a name="Modifying_the_Database"></a></h2>
    
<p> The first thing we have to do in order to assign visits to vets, is to change the database to reflect
      this. As we use an in-memory-database (HSQLDB) that is initialized from a script file, we only have to change the
      script file. We have to stop the server first by pressing the following keys: </p>
    
<div class="source">
<pre>
ctrl + c
    </pre></div>
    
<p> We now have to edit the file <tt>initDB.sql</tt> (in
        <tt>src/main/resources/db/hsqldb/</tt>). We have to add a database column to the table
        <i><tt>visits</tt></i> referencing the table <i><tt>vets</tt></i>. We change the line </p>
    
<div class="source">
<pre>
     
DROP TABLE vet_specialties IF EXISTS;
DROP TABLE vets IF EXISTS;
DROP TABLE specialties IF EXISTS;
DROP TABLE visits IF EXISTS;
DROP TABLE pets IF EXISTS;
DROP TABLE types IF EXISTS;
DROP TABLE owners IF EXISTS;

CREATE TABLE visits (
    id          INTEGER IDENTITY PRIMARY KEY,
    pet_id      INTEGER NOT NULL,
    visit_date  DATE,
    description VARCHAR(255)
);
ALTER TABLE visits ADD CONSTRAINT fk_visits_pets FOREIGN KEY (pet_id) REFERENCES pets (id);
CREATE INDEX visits_pet_id ON visits (pet_id);

    
    </pre></div>
    
<p> into </p>
    
<div class="source">
<pre>
     
DROP TABLE vet_specialties IF EXISTS;
DROP TABLE visits IF EXISTS;
DROP TABLE vets IF EXISTS;
DROP TABLE specialties IF EXISTS;
DROP TABLE pets IF EXISTS;
DROP TABLE types IF EXISTS;
DROP TABLE owners IF EXISTS;

[...]

CREATE TABLE visits (
    id          INTEGER IDENTITY PRIMARY KEY,
    pet_id      INTEGER NOT NULL,
    vet_id      INTEGER NOT NULL,
    visit_date  DATE,
    description VARCHAR(255)
);
ALTER TABLE visits ADD CONSTRAINT fk_visits_pets FOREIGN KEY (pet_id) REFERENCES pets (id);
ALTER TABLE visits ADD CONSTRAINT fk_visits_vets FOREIGN KEY (vet_id) REFERENCES vets(id);
CREATE INDEX visits_pet_id ON visits (pet_id);

    
    </pre></div>
    
<p> Additionally we have to extend all <i><tt>INSERT</tt></i> statements into the table
        <i><tt>visits</tt></i> to fill the additional column. Change in the file
        <tt>populateDB.sql</tt> (in <tt>src/main/resources/db/hsqldb/</tt>)</p>
    
<div class="source">
<pre>
     
INSERT INTO visits VALUES (1, 7, '2013-01-01', 'rabies shot');
INSERT INTO visits VALUES (2, 8, '2013-01-02', 'rabies shot');
INSERT INTO visits VALUES (3, 8, '2013-01-03', 'neutered');
INSERT INTO visits VALUES (4, 7, '2013-01-04', 'spayed');
    
    </pre></div>
    
<p> into </p>
    
<div class="source">
<pre>
    
INSERT INTO visits VALUES (1, 7, 1, '2013-01-01', 'rabies shot');
INSERT INTO visits VALUES (2, 8, 1, '2013-01-02', 'rabies shot');
INSERT INTO visits VALUES (3, 8, 2, '2013-01-03', 'neutered');
INSERT INTO visits VALUES (4, 7, 3, '2013-01-04', 'spayed');
    
    </pre></div>
  </div>
  
<div class="section">
<h2>     Modifying the Domain Model<a name="Modifying_the_Domain_Model"></a></h2>
    
<p> The base-class of all our entities is <i><tt>BaseEntity</tt></i> (in
        <tt>src/main/java/org/springframework/samples/petclinic/model/BaseEntity.java</tt>). For proper
      object-handling we add two methods here: <i><tt>equals</tt></i> and <i><tt>hashCode</tt></i>. </p>
    
<p> Add </p>
    
<div class="source">
<pre>
      
public int hashCode() {
    if (isNew()) {
        return System.identityHashCode(this); 
    } else {
        return id;
    }
}

public boolean equals(Object object) {
    if (!(object instanceof BaseEntity)) {
        return false;
    }
    if (isNew()) {
        return this == object;
    }
    return getId().equals(((BaseEntity)object).getId());
}
      
    </pre></div>
    
<p> Now we can modify our model to reflect the relation between visits and vets. We add the following code to the
      file <tt>Visit.java</tt> (in
      <tt>src/main/java/org/springframework/samples/petclinic/model/</tt>) </p>
    
<div class="source">
<pre>
      
@ManyToOne(cascade = CascadeType.ALL, fetch = FetchType.EAGER)
@JoinColumn(name = &quot;vet_id&quot;)
/** Holds value of property pet. */
private Vet vet;

public Visit(Pet pet) {
    this();
    setPet(pet);
}

/** Getter for property vet.
 * @return Value of property vet.
 */
public Vet getVet() {
    return this.vet;
}

/** Setter for property vet.
 * @param pet New value of property vet.
 */
public void setVet(Vet vet) {
    this.vet = vet;
}
      
    </pre></div>
    
<p> Since we don't know how many visits a vet may have (that may be many), we don't want to model the relation
      between vets and visits bidirectional. Instead we add a method to the <i><tt>ClinicService</tt></i> interface to
      retrieve all visits of a specified vet. So it is easy to implement filtering or lazy loading of visits later. </p>
    
<p> Add the following code to the <i><tt>ClinicService</tt></i> interface (in <tt>ClinicService.java</tt>,
      which is in <tt>src/main/java/org/springframework/samples/petclinic/service/</tt>). </p>
    
<div class="source">
<pre>
      
/**
 * Retrieve &lt;code&gt;Visit&lt;/code&gt;s from the data store,
 * returning all visits at a given vet.
 * @param vet the visited vet
 * @return a &lt;code&gt;Collection&lt;/code&gt; of matching &lt;code&gt;Visit&lt;/code&gt;s
 * (or an empty &lt;code&gt;Collection&lt;/code&gt; if none found)
 */
Collection&lt;Visit&gt; findVisits(Vet vet) throws DataAccessException;
      
    </pre></div>
    
<p> Moreover we need to load all visits of a vet from the database. For that we add the following code in <tt>VisitRepository.java</tt> (in
      <tt>src/main/java/org/springframework/samples/petclinic/repository/</tt>). </p>
    
<div class="source">
<pre>
      
List&lt;Visit&gt; findByVet(Vet vet);
      
    </pre></div>
    
<p> We also add the implementation of this methods in <tt>ClinicServiceImpl.java</tt> (in
      <tt>src/main/java/org/springframework/samples/petclinic/service/</tt>) </p>
    
<div class="source">
<pre>
      
@Override
@Transactional(readOnly = true)
public Collection&lt;Visit&gt; findVisits(Vet vet) {
    return visitRepository.findByVetId(vet);
}
      
    </pre></div>
    
<p> and in <tt>JpaVisitRepositoryImpl.java</tt> (in
      <tt>src/main/java/org/springframework/samples/petclinic/repository/jpa/</tt>) </p>
    
<div class="source">
<pre>
      
@Override
@SuppressWarnings(&quot;unchecked&quot;)
public List&lt;Visit&gt; findByVet(Vet vet) {
    Query query = this.em.createQuery(&quot;SELECT visit FROM Visit visit where visit.vet.id= :id&quot;);
    query.setParameter(&quot;id&quot;, vet.getId());
    return query.getResultList();
}
      
    </pre></div>
      
<p>Because of the ability to assign visits to vets, we have to change the <i><tt>save</tt></i>-method for visits. Therefore we change in <tt>JpaVisitRepositoryImpl.java</tt>
          (in <tt>src/main/java/org/springframework/samples/petclinic/repository/jpa/</tt>)
      </p>
      
<div class="source">
<pre>
      
@Override
public void save(Visit visit) {
    if (visit.getId() == null) {
        this.em.persist(visit);
    } else {
        this.em.merge(visit);
    }
}     
      
      </pre></div>
      
<p>into</p>
      
<div class="source">
<pre>
      
@Override
public void save(Visit visit) {
    if(visit.getId() != null) {
        Visit v = findById(visit.getId());
        v.setDate(visit.getDate());
        v.setDescription(visit.getDescription());
    } else {
        this.em.merge(visit);
    }
    this.em.flush();
}
          
      </pre></div>
  </div>
  
<div class="section">
<h2>     Modifying the View<a name="Modifying_the_View"></a></h2>
    
<p> The last thing we have to do is to modify the JSPs to see the relation, navigate it and add it when adding a
      visit. </p>
    
<p> First we add a link to the vet in the view of the owner (in the file <tt>ownerDetails.jsp</tt> in
        <tt>src/main/webapp/WEB-INF/jsp/owners/</tt>). </p>
    
<p> Change </p>
    
<div class="source">
<pre>
      
&lt;table class=&quot;table-condensed&quot;&gt;
    &lt;thead&gt;
        &lt;tr&gt;
            &lt;th&gt;Visit Date&lt;/th&gt;
            &lt;th&gt;Description&lt;/th&gt;
        &lt;/tr&gt;
    &lt;/thead&gt;
    &lt;c:forEach var=&quot;visit&quot; items=&quot;${pet.visits}&quot;&gt;
        &lt;tr&gt;
            &lt;td&gt;&lt;joda:format value=&quot;${visit.date}&quot; pattern=&quot;yyyy-MM-dd&quot;/&gt;&lt;/td&gt;
            &lt;td&gt;&lt;c:out value=&quot;${visit.description}&quot;/&gt;&lt;/td&gt;
        &lt;/tr&gt;
    &lt;/c:forEach&gt;
    &lt;tr&gt;
        &lt;td&gt; 
            &lt;spring:url value=&quot;/owners/{ownerId}/pets/{petId}/edit&quot; var=&quot;petUrl&quot;&gt;
                &lt;spring:param name=&quot;ownerId&quot; value=&quot;${owner.id}&quot;/&gt;
                &lt;spring:param name=&quot;petId&quot; value=&quot;${pet.id}&quot;/&gt;
            &lt;/spring:url&gt;
            &lt;a href=&quot;${fn:escapeXml(petUrl)}&quot;&gt;Edit Pet&lt;/a&gt;
        &lt;/td&gt;
        &lt;td&gt;
            &lt;spring:url value=&quot;/owners/{ownerId}/pets/{petId}/visits/new&quot; var=&quot;visitUrl&quot;&gt;
                &lt;spring:param name=&quot;ownerId&quot; value=&quot;${owner.id}&quot;/&gt;
                &lt;spring:param name=&quot;petId&quot; value=&quot;${pet.id}&quot;/&gt;
            &lt;/spring:url&gt;
            &lt;a href=&quot;${fn:escapeXml(visitUrl)}&quot;&gt;Add Visit&lt;/a&gt;
       &lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;
      
    </pre></div>
    
<p> into </p>
    
<div class="source">
<pre>
      
&lt;table class=&quot;table-condensed&quot;&gt;
    &lt;thead&gt;
        &lt;tr&gt;
            &lt;th&gt;Vet&lt;/th&gt;
            &lt;th&gt;Visit Date&lt;/th&gt;
            &lt;th&gt;Description&lt;/th&gt;
        &lt;/tr&gt;
    &lt;/thead&gt;
    &lt;c:forEach var=&quot;visit&quot; items=&quot;${pet.visits}&quot;&gt;
        &lt;tr&gt;
            &lt;td&gt;          
                &lt;spring:url value=&quot;/vets/{vetId}&quot; var=&quot;vetUrl&quot;&gt;
                    &lt;spring:param name=&quot;vetId&quot; value=&quot;${visit.vet.id}&quot;/&gt;
                &lt;/spring:url&gt;
                &lt;a href=&quot;${fn:escapeXml(vetUrl)}&quot;&gt;${visit.vet.firstName} ${visit.vet.lastName}&lt;/a&gt;
            &lt;/td&gt;
            &lt;td&gt;&lt;joda:format value=&quot;${visit.date}&quot; pattern=&quot;yyyy-MM-dd&quot;/&gt;&lt;/td&gt;
            &lt;td&gt;&lt;c:out value=&quot;${visit.description}&quot;/&gt;&lt;/td&gt;
        &lt;/tr&gt;
    &lt;/c:forEach&gt;
    &lt;tr&gt;
        &lt;td&gt; 
            &lt;spring:url value=&quot;/owners/{ownerId}/pets/{petId}/edit&quot; var=&quot;petUrl&quot;&gt;
                &lt;spring:param name=&quot;ownerId&quot; value=&quot;${owner.id}&quot;/&gt;
                &lt;spring:param name=&quot;petId&quot; value=&quot;${pet.id}&quot;/&gt;
            &lt;/spring:url&gt;
            &lt;a href=&quot;${fn:escapeXml(petUrl)}&quot;&gt;Edit Pet&lt;/a&gt;
        &lt;/td&gt;
        &lt;td&gt;
            &lt;spring:url value=&quot;/owners/{ownerId}/pets/{petId}/visits/new&quot; var=&quot;visitUrl&quot;&gt;
                &lt;spring:param name=&quot;ownerId&quot; value=&quot;${owner.id}&quot;/&gt;
                &lt;spring:param name=&quot;petId&quot; value=&quot;${pet.id}&quot;/&gt;
            &lt;/spring:url&gt;
            &lt;a href=&quot;${fn:escapeXml(visitUrl)}&quot;&gt;Add Visit&lt;/a&gt;
        &lt;/td&gt;
    &lt;/tr&gt;
&lt;/table&gt;
      
    </pre></div>
    
<p> Second we add a page to display a single vet with the list of visits. We name this file
        <tt>vet.jsp</tt> and put it into <tt>src/main/webapp/WEB-INF/jsp/vets/</tt>. This is the
      content of the file: </p>
    
<div class="source">
<pre>
      
&lt;!DOCTYPE html&gt; 

&lt;%@ taglib prefix=&quot;spring&quot; uri=&quot;http://www.springframework.org/tags&quot; %&gt;
&lt;%@ taglib prefix=&quot;fn&quot; uri=&quot;http://java.sun.com/jsp/jstl/functions&quot; %&gt;
&lt;%@ taglib prefix=&quot;c&quot; uri=&quot;http://java.sun.com/jsp/jstl/core&quot; %&gt;
&lt;%@ taglib prefix=&quot;joda&quot; uri=&quot;http://www.joda.org/joda/time/tags&quot; %&gt;

&lt;html lang=&quot;en&quot;&gt;

&lt;jsp:include page=&quot;../fragments/headTag.jsp&quot;/&gt;

&lt;body&gt;
    &lt;div class=&quot;container&quot;&gt;
        &lt;jsp:include page=&quot;../fragments/bodyHeader.jsp&quot;/&gt;
      
        &lt;h2&gt;Vet Information&lt;/h2&gt;
        
          &lt;table&gt;
              &lt;tr&gt;
                  &lt;th&gt;Name&lt;/th&gt;
                  &lt;td&gt;&lt;b&gt;${vet.firstName} ${vet.lastName}&lt;/b&gt;&lt;/td&gt;
              &lt;/tr&gt;
              &lt;tr&gt;
                  &lt;th&gt;Specialities&lt;/th&gt;
                  &lt;td&gt;
                	    &lt;c:forEach var=&quot;specialty&quot; items=&quot;${vet.specialties}&quot;&gt;
                          ${specialty.name}
                      &lt;/c:forEach&gt;
                      &lt;c:if test=&quot;${vet.nrOfSpecialties == 0}&quot;&gt;none&lt;/c:if&gt;
                  &lt;/td&gt;
              &lt;/tr&gt;
          &lt;/table&gt;
    
        &lt;h2&gt;Visits&lt;/h2&gt;
        
        &lt;c:forEach var=&quot;visit&quot; items=&quot;${visits}&quot;&gt;
            &lt;table width=&quot;94%&quot;&gt;
                &lt;tr&gt;
                    &lt;th&gt;Date&lt;/th&gt;
                    &lt;td&gt;&lt;joda:format value=&quot;${visit.date}&quot; pattern=&quot;yyyy-MM-dd&quot;/&gt;&lt;/td&gt;
                &lt;/tr&gt;
                &lt;tr&gt;
                    &lt;th&gt;Pet&lt;/th&gt;
                    &lt;td&gt;${visit.pet.name}&lt;/td&gt;
                &lt;/tr&gt;
                &lt;tr&gt;
                    &lt;th&gt;Type&lt;/th&gt;
                    &lt;td&gt;${visit.pet.type.name}&lt;/td&gt;
                &lt;/tr&gt;
                &lt;tr&gt;
                    &lt;th&gt;Owner&lt;/th&gt;
                    &lt;td&gt;
                        &lt;spring:url value=&quot;/owners/{ownerId}&quot; var=&quot;ownerUrl&quot;&gt;
                            &lt;spring:param name=&quot;ownerId&quot; value=&quot;${visit.pet.owner.id}&quot;/&gt;
                        &lt;/spring:url&gt;
                        &lt;a href=&quot;${fn:escapeXml(ownerUrl)}&quot;&gt;${visit.pet.owner.firstName} ${visit.pet.owner.lastName}&lt;/a&gt;
                    &lt;/td&gt;
                &lt;/tr&gt;
                &lt;tr&gt;
                    &lt;th&gt;Description&lt;/th&gt;
                    &lt;td&gt;${visit.description}&lt;/td&gt;
                &lt;/tr&gt;
            &lt;/table&gt;
            &lt;table class=&quot;table-buttons&quot;&gt;
                &lt;tr&gt;
                    &lt;td&gt;
                        &lt;spring:url value=&quot;/pets/{petId}/visits/{visitId}/edit&quot; var=&quot;visitUrl&quot;&gt;
                            &lt;spring:param name=&quot;petId&quot; value=&quot;${visit.pet.id}&quot;/&gt;
                            &lt;spring:param name=&quot;visitId&quot; value=&quot;${visit.id}&quot;/&gt;
                        &lt;/spring:url&gt;
                        &lt;a href=&quot;${fn:escapeXml(visitUrl)}&quot;&gt;Edit Visit&lt;/a&gt;
                    &lt;/td&gt;
                &lt;/tr&gt;
            &lt;/table&gt;
        &lt;/c:forEach&gt;
      
        &lt;jsp:include page=&quot;../fragments/footer.jsp&quot;/&gt;
    &lt;/div&gt;
&lt;/body&gt;

&lt;/html&gt;
      
    </pre></div>
    
<p> To make the model available for the new vet-view, we add a method to load a vet to the
        <i><tt>ClinicService</tt></i> interface. </p>
    
<p> Add the following code to the <i><tt>ClinicService</tt></i> interface (in <tt>ClinicService.java</tt>,
      which is in <tt>src/main/java/org/springframework/samples/petclinic/service/</tt>). </p>
    
<div class="source">
<pre>
      
/**
 * Retrieve a &lt;code&gt;Vet&lt;/code&gt; from the data store by id.
 * @param id the id to search for
 * @return the &lt;code&gt;Vet&lt;/code&gt; if found
 * @throws org.springframework.dao.DataRetrievalFailureException if not found
 */
Vet findVetById(int id) throws DataAccessException;
      
    </pre></div>
    
<p> Moreover we need to load a specified vet from the database. For that we add the following code in <tt>VetRepository.java</tt> (in
      <tt>src/main/java/org/springframework/samples/petclinic/repository/</tt>) </p>
    
<div class="source">
<pre>
      
/**
* Retrieve a &lt;code&gt;Vet&lt;/code&gt; from the data store by id.
* @param id the id to search for
* @return the &lt;code&gt;Vet&lt;/code&gt; if found
* @throws org.springframework.dao.DataRetrievalFailureException if not found
*/
Vet findById(int id) throws DataAccessException;
      
    </pre></div>
    
<p> We also add the implementation of this methods in <tt>ClinicServiceImpl.java</tt> (in
        <tt>src/main/java/org/springframework/samples/petclinic/service/</tt>) </p>
    
<div class="source">
<pre>
      
@Override
@Transactional(readOnly = true)
public Vet findVetById(int id) throws DataAccessException {
    return vetRepository.findById(id);
}
      
    </pre></div>
    
<p> and in <tt>JpaVetRepositoryImpl.java</tt> (in
      <tt>src/main/java/org/springframework/samples/petclinic/repository/jpa/</tt>). </p>
    
<div class="source">
<pre>
      
@Override
public Vet findById(int id) {
    return this.em.find(Vet.class, id);
}
      
    </pre></div>
    
<p> Last we have to add the following code to <tt>VetController.java</tt> (in
        <tt>src/main/java/org/springframework/samples/petclinic/web/)</tt>. And don't forget to add the
      <i><tt>import</tt></i>-statement for the <i><tt>ModelAndView</tt></i>. </p>
    
<div class="source">
<pre>
      
/**
 * Displaying a vet.
 *
 * @param vetId the ID of the vet to display
 * @return a ModelMap with the model attributes for the view
 */
@RequestMapping(value=&quot;/vets/{vetId}&quot;)
public ModelAndView showVet(@PathVariable(&quot;vetId&quot;) int vetId) {
    ModelAndView mav = new ModelAndView(&quot;vets/vet&quot;);
    Vet vet = this.clinicService.findVetById(vetId);
    mav.addObject(vet);
    mav.addObject(&quot;visits&quot;, this.clinicService.findVisits(vet));
    return mav;
}
      
    </pre></div>
    
<p> We may also modify <tt>vetList.jsp</tt> in <tt>src/main/webapp/WEB-INF/jsp/vets/</tt> to add
      links to our newly created vet-page. </p>
    
<p> Change </p>
    
<div class="source">
<pre>
      
&lt;%@ taglib prefix=&quot;spring&quot; uri=&quot;http://www.springframework.org/tags&quot; %&gt;
&lt;%@ taglib prefix=&quot;fmt&quot; uri=&quot;http://java.sun.com/jsp/jstl/fmt&quot; %&gt;
&lt;%@ taglib prefix=&quot;c&quot; uri=&quot;http://java.sun.com/jsp/jstl/core&quot; %&gt;
&lt;%@ taglib prefix=&quot;datatables&quot; uri=&quot;http://github.com/dandelion/datatables&quot; %&gt;

[...]

&lt;datatables:column title=&quot;Name&quot;&gt;
    &lt;c:out value=&quot;${vet.firstName} ${vet.lastName}&quot;&gt;&lt;/c:out&gt;
&lt;/datatables:column&gt;
      
    </pre></div>
    
<p> into </p>
    
<div class="source">
<pre>
      
&lt;%@ taglib prefix=&quot;spring&quot; uri=&quot;http://www.springframework.org/tags&quot; %&gt;
&lt;%@ taglib prefix=&quot;fmt&quot; uri=&quot;http://java.sun.com/jsp/jstl/fmt&quot; %&gt;
&lt;%@ taglib prefix=&quot;c&quot; uri=&quot;http://java.sun.com/jsp/jstl/core&quot; %&gt;
&lt;%@ taglib prefix=&quot;datatables&quot; uri=&quot;http://github.com/dandelion/datatables&quot; %&gt;
&lt;%@ taglib prefix=&quot;fn&quot; uri=&quot;http://java.sun.com/jsp/jstl/functions&quot; %&gt;

[...]

&lt;datatables:column title=&quot;Name&quot;&gt;
    &lt;spring:url value=&quot;/vets/{vetId}&quot; var=&quot;vetUrl&quot;&gt;
        &lt;spring:param name=&quot;vetId&quot; value=&quot;${vet.id}&quot;/&gt;
    &lt;/spring:url&gt;
    &lt;a href=&quot;${fn:escapeXml(vetUrl)}&quot;&gt;
        &lt;c:out value=&quot;${vet.firstName} ${vet.lastName}&quot;&gt;&lt;/c:out&gt;
    &lt;/a&gt;
&lt;/datatables:column&gt;
      
    </pre></div>
    
<p> There is one thing more to do in order to establish the relation between visits and vets: An owner must be
      able to select a vet when making an appointment. </p>
    
<p> We achieve this by adding the following lines of code to <tt>VisitController.java</tt> (in
        <tt>src/main/java/org/springframework/samples/petclinic/web/)</tt>. Again don't forget the
        <i><tt>import</tt></i>-statements. </p>
    
<div class="source">
<pre>
      
@ModelAttribute(&quot;vets&quot;)
public Collection&lt;Vet&gt; populateVets() {
    return this.clinicService.findVets();
}
      
    </pre></div>
    
<p> Now we can put a vet-selector into <tt>createOrUpdateVisitForm.jsp</tt> (in
        <tt>src/main/webapp/WEB-INF/jsp/pets/</tt>
    </p>
    
<p> Change </p>
    
<div class="source">
<pre>
      
&lt;form:form modelAttribute=&quot;visit&quot;&gt;
    &lt;div class=&quot;control-group&quot;&gt;
        &lt;label class=&quot;control-label&quot;&gt;Date &lt;/label&gt;

        &lt;div class=&quot;controls&quot;&gt;
            &lt;form:input path=&quot;date&quot;/&gt;
            &lt;span class=&quot;help-inline&quot;&gt;&lt;form:errors path=&quot;date&quot;/&gt;&lt;/span&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;control-group&quot;&gt;
        &lt;label class=&quot;control-label&quot;&gt;Description &lt;/label&gt;

        &lt;div class=&quot;controls&quot;&gt;
            &lt;form:input path=&quot;description&quot;/&gt;
            &lt;span class=&quot;help-inline&quot;&gt;&lt;form:errors path=&quot;description&quot;/&gt;&lt;/span&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;form-actions&quot;&gt;
        &lt;input type=&quot;hidden&quot; name=&quot;petId&quot; value=&quot;${visit.pet.id}&quot;/&gt;
        &lt;button type=&quot;submit&quot;&gt;Add Visit&lt;/button&gt;
    &lt;/div&gt;
&lt;/form:form&gt;
      
    </pre></div>
    
<p> into </p>
    
<div class="source">
<pre>
      
&lt;form:form modelAttribute=&quot;visit&quot;&gt;
    &lt;div class=&quot;control-group&quot;&gt;
        &lt;label class=&quot;control-label&quot;&gt;Date &lt;/label&gt;

        &lt;div class=&quot;controls&quot;&gt;
            &lt;form:input path=&quot;date&quot;/&gt;
            &lt;span class=&quot;help-inline&quot;&gt;&lt;form:errors path=&quot;date&quot;/&gt;&lt;/span&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;control-group&quot;&gt;
        &lt;label class=&quot;control-label&quot;&gt;Vet &lt;/label&gt;

        &lt;div class=&quot;controls&quot;&gt;
            &lt;form:select path=&quot;vet&quot; items=&quot;${vets}&quot;/&gt;
            &lt;span class=&quot;help-inline&quot;&gt;&lt;form:errors path=&quot;vet&quot;/&gt;&lt;/span&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;control-group&quot;&gt;
        &lt;label class=&quot;control-label&quot;&gt;Description &lt;/label&gt;

        &lt;div class=&quot;controls&quot;&gt;
            &lt;form:input path=&quot;description&quot;/&gt;
            &lt;span class=&quot;help-inline&quot;&gt;&lt;form:errors path=&quot;description&quot;/&gt;&lt;/span&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;form-actions&quot;&gt;
        &lt;input type=&quot;hidden&quot; name=&quot;petId&quot; value=&quot;${visit.pet.id}&quot;/&gt;
        &lt;button type=&quot;submit&quot;&gt;Add Visit&lt;/button&gt;
    &lt;/div&gt;
&lt;/form:form&gt;
      
    </pre></div>
    
<p> Adding the vet to the list of previous visits remains as an exercise to you. </p>
    
<p> In order to display a meaningful text in our vet-selector, we have to override the
        <i><tt>toString()</tt></i>-method in the class <i><tt>Vet</tt></i>. </p>
    
<p> Add the following code to <tt>Person.java</tt> since it is the superclass of
        <i><tt>Vet</tt></i>. (in <tt>src/main/java/org/springframework/samples/petclinic/model/</tt>). </p>
    
<div class="source">
<pre>
      
public String toString() {
    return this.getLastName() + &quot;, &quot; + this.getFirstName();
}
      
    </pre></div>
    
<p> Additionally add the following code to <tt>Vet.java</tt> (in
        <tt>src/main/java/org/springframework/samples/petclinic/model/</tt>). </p>
    
<div class="source">
<pre>
      
public String toString() {
    StringBuilder specialties = new StringBuilder();
    for (Specialty specialty: getSpecialties()) {
        specialties.append(' ').append(specialty.getName()).append(',');
    }
    if (getNrOfSpecialties() == 0) {
        specialties.append(&quot;(none)&quot;);
    } else {
        specialties.setCharAt(0, '(');
        specialties.setCharAt(specialties.length() - 1, ')');
    }
    return super.toString() + &quot; &quot; + specialties.toString();
}
      
    </pre></div>
    
<p> The vet is now displayed human-readable in the drop-down-box, but we have to ensure that the displayed text
        can be reverted to a vet properly. We do this by adding a vet-formatter. </p>
    
<p> Create the file <tt>VetFormatter.java</tt> in
        <tt>src/main/java/org/springframework/samples/petclinic/web/</tt> and fill it with the following
      content. </p>
    
<div class="source">
<pre>
      
package org.springframework.samples.petclinic.web;


import java.text.ParseException;
import java.util.Collection;
import java.util.Locale;

import org.springframework.format.Formatter;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.samples.petclinic.model.Vet;
import org.springframework.samples.petclinic.service.ClinicService;


public class VetFormatter implements Formatter&lt;Vet&gt; {

    private final ClinicService clinicService;
  
  
    @Autowired
    public VetFormatter(ClinicService clinicService) {
        this.clinicService = clinicService;
    }
  
    @Override
    public String print(Vet vet, Locale locale) {
        return vet.toString();
    }
  
    @Override
    public Vet parse(String text, Locale locale) throws ParseException {
        Collection&lt;Vet&gt; findVets = this.clinicService.findVets();
        for (Vet vet : findVets) {
            if (vet.toString().equals(text)) {
                return vet;
            }
        }
        throw new ParseException(&quot;vet not found: &quot; + text, 0);
    }

}
      
    </pre></div>
    
<p>For this we have to change also the code in <tt>mvc-core-config.xml</tt> (in <tt>src/main/resources/spring/</tt>). 
      Change</p>
    
<div class="source">
<pre>
      
&lt;bean id=&quot;conversionService&quot; class=&quot;org.springframework.format.support.FormattingConversionServiceFactoryBean&quot;&gt;
    &lt;property name=&quot;formatters&quot;&gt;
        &lt;set&gt;
            &lt;bean class=&quot;org.springframework.samples.petclinic.web.PetTypeFormatter&quot;/&gt;
        &lt;/set&gt;
    &lt;/property&gt;
&lt;/bean&gt;
            
    </pre></div>
    
<p>into</p>
    
<div class="source">
<pre>
      
&lt;bean id=&quot;conversionService&quot; class=&quot;org.springframework.format.support.FormattingConversionServiceFactoryBean&quot;&gt;
    &lt;property name=&quot;formatters&quot;&gt;
        &lt;set&gt;
            &lt;bean class=&quot;org.springframework.samples.petclinic.web.PetTypeFormatter&quot;/&gt;
            &lt;bean class=&quot;org.springframework.samples.petclinic.web.VetFormatter&quot;/&gt;
        &lt;/set&gt;
    &lt;/property&gt;
&lt;/bean&gt;
            
    </pre></div>
    
<p> Now we are able to add visits for pets and select the vet to visit. Another requirement of our application
      was that the vet is able to modify an existing visit. First we must be able to load a visit. </p>
    
<p> Add the following code to the <i><tt>ClinicService</tt></i> interface (in <tt>ClinicService.java</tt>,
      which is in <tt>src/main/java/org/springframework/samples/petclinic/service/</tt>). </p>
    
<div class="source">
<pre>
      
/**
 * Retrieve a &lt;code&gt;Visit&lt;/code&gt; from the data store by id.
 * @param id the id to search for
 * @return the &lt;code&gt;Visit&lt;/code&gt; if found
 * @throws org.springframework.dao.DataRetrievalFailureException if not found
 */
Visit findVisitById(int id) throws DataAccessException;
      
    </pre></div>
    
<p> Moreover we need to load a visit from the database. For that we add the following code and in <tt>VisitRepository.java</tt> (in
      <tt>src/main/java/org/springframework/samples/petclinic/repository/</tt>) </p>
    
<div class="source">
<pre>
      
/**
 * Retrieve a &lt;code&gt;Visit&lt;/code&gt; from the data store by id.
 * @param id the id to search for
 * @return the &lt;code&gt;Visit&lt;/code&gt; if found
 * @throws org.springframework.dao.DataRetrievalFailureException if not found
 */
Visit findById(int id) throws DataAccessException;
      
    </pre></div>
    
<p> We also add the implementation of this methods in <tt>ClinicServiceImpl.java</tt> (in
      <tt>src/main/java/org/springframework/samples/petclinic/service/</tt>) </p>
    
<div class="source">
<pre>
      
@Override
@Transactional(readOnly = true)
public Visit findVisitById(int id) throws DataAccessException {
    return visitRepository.findBy(id);
}
      
    </pre></div>
    
<p> and in <tt>JpaVisitRepositoryImpl.java</tt> (in
      <tt>src/main/java/org/springframework/samples/petclinic/repository/jpa/</tt>) </p>
    
<div class="source">
<pre>
      
@Override
public Visit findById(int id) {
    return this.em.find(Visit.class, id);
}
      
    </pre></div>
    
<p> Now we can create a form to edit a visit. For that we need to create a <tt>VisitValidator.java</tt> (in <tt>
      src/main/java/org/springframework/samples/petclinic/web/</tt>)</p>
    
<div class="source">
<pre>
      
package org.springframework.samples.petclinic.web;

import org.springframework.samples.petclinic.model.Visit;
import org.springframework.util.StringUtils;
import org.springframework.validation.Errors;

/**
  * &lt;code&gt;Validator&lt;/code&gt; for &lt;code&gt;Visit&lt;/code&gt; forms.
  *
  */
public class VisitValidator {

    public void validate(Visit visit, Errors errors) {
        if (!StringUtils.hasLength(visit.getDescription())) {
             errors.rejectValue(&quot;description&quot;, &quot;required&quot;, &quot;required&quot;);
        }
    }
}
      
    </pre></div>   
    
<p>Now we add the following code to the file <tt>VisitController.java</tt>
        (in <tt>src/main/java/org/springframework/samples/petclinic/web/</tt>) </p>
    
<div class="source">
<pre>
      
@RequestMapping(value = &quot;/pets/{petId}/visits/{visitId}/edit&quot;, method = RequestMethod.GET)
public String initUpdateForm(@PathVariable(&quot;visitId&quot;) int visitId, Model model) {
    Visit visit = this.clinicService.findVisitById(visitId);
    model.addAttribute(&quot;visit&quot;, visit);
    return &quot;pets/createOrUpdateVisitForm&quot;;
}

@RequestMapping(value = &quot;/pets/{petId}/visits/{visitId}/edit&quot;, method = { RequestMethod.PUT, RequestMethod.POST })
public String processUpdateForm(@ModelAttribute(&quot;visit&quot;) Visit visit, BindingResult result, SessionStatus status) {
    new VisitValidator().validate(visit, result);
    if (result.hasErrors()) {
        return &quot;pets/createOrUpdateVisitForm&quot;;
    } else {
        this.clinicService.saveVisit(visit);
        status.setComplete();
        return &quot;redirect:/vets/&quot; + visit.getVet().getId();
    }
}
      
    </pre></div>
    
<p> As view we can reuse the <tt>createOrUpdateVisitForm.jsp</tt> from
        <tt>src/main/webapp/WEB-INF/jsp/pets/</tt>. We just have to make two modifications: </p>
    
<p> Change </p>
    
<div class="source">
<pre>
      
&lt;div class=&quot;controls&quot;&gt;
    &lt;form:select path=&quot;vet&quot; items=&quot;${vets}&quot;/&gt;
    &lt;span class=&quot;help-inline&quot;&gt;&lt;form:errors path=&quot;vet&quot;/&gt;&lt;/span&gt;
&lt;/div&gt;
      
    </pre></div>
    
<p> into </p>
    
<div class="source">
<pre>
      
&lt;div class=&quot;controls&quot;&gt;
    &lt;c:choose&gt;
        &lt;c:when test=&quot;${visit['new']}&quot;&gt;
            &lt;form:select path=&quot;vet&quot; items=&quot;${vets}&quot;/&gt;
        &lt;/c:when&gt;
        &lt;c:otherwise&gt;
            ${visit.vet.firstName} ${visit.vet.lastName}
        &lt;/c:otherwise&gt;
    &lt;/c:choose&gt;
    &lt;span class=&quot;help-inline&quot;&gt;&lt;form:errors path=&quot;vet&quot;/&gt;&lt;/span&gt;
&lt;/div&gt;
      
    </pre></div>
    
<p> Second we change the label of the button. Change </p>
    
<div class="source">
<pre>
      
&lt;div class=&quot;form-actions&quot;&gt;
    &lt;input type=&quot;hidden&quot; name=&quot;petId&quot; value=&quot;${visit.pet.id}&quot;/&gt;
    &lt;button type=&quot;submit&quot;&gt;Add Visit&lt;/button&gt;
&lt;/div&gt;
      
    </pre></div>
    
<p> into </p>
    
<div class="source">
<pre>
      
&lt;div class=&quot;form-actions&quot;&gt;
    &lt;c:choose&gt;
        &lt;c:when test=&quot;${visit['new']}&quot;&gt;
            &lt;input type=&quot;hidden&quot; name=&quot;petId&quot; value=&quot;${visit.pet.id}&quot;/&gt;
            &lt;button type=&quot;submit&quot;&gt;Add Visit&lt;/button&gt;
        &lt;/c:when&gt;
        &lt;c:otherwise&gt;
            &lt;button type=&quot;submit&quot;&gt;Update Visit&lt;/button&gt;
        &lt;/c:otherwise&gt;
    &lt;/c:choose&gt;
&lt;/div&gt;
      
    </pre></div>
    
<p> As we already added a button to edit a visit to <tt>vet.jsp</tt>, we do not need any more to do
      to integrate the visit-editor. We can start our server again and see, if our new relation between visits and vets
      works. (Navigate to <a class="externalLink" href="http://localhost:9966/owners/6">Jean
        Coleman</a> as there are already added some visits.) </p>
  </div>

<div class="section">
<h2></h2><hr /><!-- Navigation Panel -->
<table class="bodyTable" width="100%" align="center" border="0">
<tr class="a">
<td align="left">Previous: <a href="tutorial.html">Tutorial</a></td>
<td align="center">Up: <a href="tutorial.html">Tutorial</a></td>
<td align="right">Next: <a href="authentication.html">Authentication</a></td></tr></table><!-- End of Navigation Panel --></div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
              Copyright &#169;                   2019.
          All Rights Reserved.      
                    
                  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
